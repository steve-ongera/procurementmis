{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ page_title }} - University Procurement System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    :root {
        --primary-color: #2563EB;
        --primary-light: #EFF6FF;
        --primary-dark: #1D4ED8;
        --secondary-color: #64748B;
        --success-color: #10B981;
        --warning-color: #F59E0B;
        --danger-color: #EF4444;
        --info-color: #3B82F6;
        --border-color: #E2E8F0;
        --card-bg: #FFFFFF;
        --hover-bg: #F8FAFC;
        --table-header: #F1F5F9;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1E293B;
        margin: 0 0 0.5rem 0;
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: var(--secondary-color);
        margin: 0;
    }

    .breadcrumb a {
        color: var(--primary-color);
        text-decoration: none;
        transition: color 0.2s;
    }

    .breadcrumb a:hover {
        color: var(--primary-dark);
        text-decoration: underline;
    }

    .breadcrumb i {
        font-size: 0.6875rem;
        color: #94A3B8;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.875rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.8125rem;
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid var(--border-color);
        cursor: pointer;
        background: var(--card-bg);
        color: var(--secondary-color);
    }

    .btn:hover {
        background: var(--hover-bg);
        transform: translateY(-1px);
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }

    /* Alert boxes */
    .alert {
        padding: 0.875rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        font-size: 0.8125rem;
        border: 1px solid;
    }

    .alert-info {
        background: #EFF6FF;
        border-color: #BFDBFE;
        color: #1E40AF;
    }

    .alert-warning {
        background: #FEF3C7;
        border-color: #FDE68A;
        color: #92400E;
    }

    .alert-success {
        background: #ECFDF5;
        border-color: #A7F3D0;
        color: #065F46;
    }

    .alert-danger {
        background: #FEF2F2;
        border-color: #FCA5A5;
        color: #DC2626;
    }

    .alert i {
        font-size: 1.125rem;
        margin-top: 0.125rem;
    }

    .alert ul, .alert ol {
        margin: 0.5rem 0 0 1.5rem;
        padding: 0;
    }

    /* Table Card */
    .table-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .table-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--table-header);
    }

    .table-title {
        font-size: 0.9375rem;
        font-weight: 600;
        color: #1E293B;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .table-title i {
        color: var(--secondary-color);
        font-size: 1rem;
    }

    /* Form Grid */
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    .form-label {
        font-size: 0.8125rem;
        font-weight: 500;
        color: #475569;
    }

    .form-control {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 0.8125rem;
        transition: all 0.2s;
        width: 100%;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-control:disabled {
        background-color: #F1F5F9;
        cursor: not-allowed;
    }

    select.form-control {
        background-color: white;
        cursor: pointer;
    }

    textarea.form-control {
        min-height: 80px;
        resize: vertical;
    }

    /* Search box styling */
    .search-box {
        position: relative;
    }

    .search-box input {
        padding-right: 2.5rem;
    }

    .search-box i {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        pointer-events: none;
    }

    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        margin-top: 0.25rem;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: none;
    }

    .search-results.active {
        display: block;
    }

    .search-result-item {
        padding: 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
    }

    .search-result-item:hover {
        background: var(--hover-bg);
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-name {
        font-weight: 500;
        color: #1E293B;
        font-size: 0.875rem;
    }

    .search-result-details {
        font-size: 0.75rem;
        color: var(--secondary-color);
        margin-top: 0.125rem;
    }

    .loading-spinner {
        text-align: center;
        padding: 1rem;
        color: var(--secondary-color);
    }

    /* Checkbox and radio styling */
    input[type="checkbox"],
    input[type="radio"] {
        width: 1rem;
        height: 1rem;
        accent-color: var(--primary-color);
        cursor: pointer;
    }

    .radio-group {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.5rem;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        transition: all 0.2s;
    }

    .radio-option:hover {
        background: var(--hover-bg);
        border-color: var(--primary-color);
    }

    .radio-option.active {
        background: var(--primary-light);
        border-color: var(--primary-color);
    }

    .radio-option input[type="radio"]:checked + span {
        color: var(--primary-color);
        font-weight: 600;
    }

    /* Plan item info box */
    .plan-item-info {
        background: var(--primary-light);
        border: 1px solid #BFDBFE;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 0.5rem;
        display: none;
        animation: slideDown 0.3s ease;
    }

    .plan-item-info.active {
        display: block;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .plan-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
        margin-top: 0.75rem;
    }

    .plan-info-item {
        display: flex;
        flex-direction: column;
    }

    .plan-info-label {
        font-size: 0.75rem;
        color: #64748B;
        font-weight: 500;
    }

    .plan-info-value {
        font-size: 0.875rem;
        color: #1E293B;
        font-weight: 600;
        margin-top: 0.125rem;
    }

    /* Item and Attachment Forms */
    .item-form,
    .attachment-form {
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background: var(--card-bg);
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .item-form h4 {
        margin: 0;
        font-size: 0.8125rem;
        font-weight: 600;
        color: #1E293B;
    }

    /* Total calculator */
    .total-calculator {
        background: var(--success-color);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
    }

    .total-label {
        font-size: 0.875rem;
        font-weight: 500;
    }

    .total-amount {
        font-size: 1.25rem;
        font-weight: 700;
    }

    /* Error styling */
    .error-message {
        color: var(--danger-color);
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    .field-error {
        border-color: var(--danger-color) !important;
    }

    /* Hidden form elements */
    input[type="hidden"] {
        display: none;
    }

    /* Help text */
    .help-text {
        font-size: 0.75rem;
        color: var(--secondary-color);
        margin-top: 0.25rem;
    }

    /* No plan items warning */
    .no-plan-items {
        padding: 1rem;
        background: #FEF2F2;
        border: 1px solid #FCA5A5;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }

    .no-plan-items strong {
        color: #DC2626;
        display: block;
        margin-bottom: 0.5rem;
    }

    .no-plan-items p {
        margin: 0;
        font-size: 0.875rem;
        color: #7F1D1D;
        line-height: 1.5;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .header-actions {
            width: 100%;
        }
        
        .header-actions .btn {
            flex: 1;
            justify-content: center;
        }
        
        .filter-grid {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .form-actions .btn {
            width: 100%;
            justify-content: center;
        }
        
        .radio-group {
            flex-direction: column;
            gap: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">{{ page_title }}</h1>
        <div class="breadcrumb">
            <a href="{% url 'staff_dashboard' %}">
                <i class="bi bi-house"></i>
                Home
            </a>
            <i class="bi bi-chevron-right"></i>
            <a href="{% url 'staff_requisitions_list' %}">My Requisitions</a>
            <i class="bi bi-chevron-right"></i>
            <span>{{ page_title }}</span>
        </div>
    </div>
    <div class="header-actions">
        <a href="{% url 'staff_requisitions_list' %}" class="btn">
            <i class="bi bi-arrow-left"></i>
            Back to List
        </a>
    </div>
</div>

<!-- Plan Enforcement Info -->
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <div>
        <strong>Procurement Plan Compliance</strong><br>
        All requisitions must be linked to approved procurement plan items unless they are genuine emergencies requiring special approval and plan amendment.
    </div>
</div>

<!-- DEBUG INFO (Remove after fixing) -->
{% if debug_info %}
<div class="alert" style="background: #FEF3C7; border-color: #FDE68A; color: #92400E;">
    <i class="bi bi-bug"></i>
    <div style="width: 100%;">
        <strong>Debug Information (Remove this section in production):</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.8125rem;">
            <li>Has Department: <strong>{{ debug_info.has_department }}</strong></li>
            <li>Department: <strong>{{ debug_info.department|default:"Not assigned" }}</strong></li>
            <li>Budget Year: <strong>{{ debug_info.budget_year|default:"No active year" }}</strong></li>
            <li>Total Plans: <strong>{{ debug_info.total_plans }}</strong></li>
            <li>Active/Approved Plans: <strong>{{ debug_info.active_plans }}</strong></li>
            <li>Plan Items Available: <strong>{{ debug_info.plan_items_count }}</strong></li>
        </ul>
        {% if debug_info.plan_items_count == 0 %}
        <div style="margin-top: 0.5rem; padding: 0.75rem; background: white; border-radius: 0.25rem; border: 1px solid #FCA5A5;">
            <strong style="color: #DC2626;">⚠️ No plan items found!</strong><br>
            <small style="display: block; margin-top: 0.25rem;">Possible reasons:</small>
            <ol style="margin: 0.25rem 0 0 1.5rem; font-size: 0.75rem;">
                {% if not debug_info.has_department %}
                <li style="color: #DC2626; font-weight: 600;">You are not assigned to a department</li>
                {% endif %}
                {% if not debug_info.budget_year %}
                <li style="color: #DC2626; font-weight: 600;">No active budget year exists</li>
                {% endif %}
                {% if debug_info.has_department and debug_info.budget_year %}
                    {% if debug_info.total_plans == 0 %}
                    <li style="color: #DC2626; font-weight: 600;">No procurement plan created for {{ debug_info.department }}</li>
                    {% elif debug_info.active_plans == 0 %}
                    <li style="color: #DC2626; font-weight: 600;">Plans exist but status is not ACTIVE or APPROVED (Total: {{ debug_info.total_plans }})</li>
                    {% else %}
                    <li style="color: #DC2626; font-weight: 600;">Plans are active but have no items with status PLANNED</li>
                    {% endif %}
                {% endif %}
            </ol>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<form method="post" enctype="multipart/form-data" id="requisitionForm">
    {% csrf_token %}

    <!-- Procurement Plan Selection -->
    <div class="table-card" style="margin-bottom: 1.5rem;">
        <div class="table-header">
            <h2 class="table-title">
                <i class="bi bi-calendar-check"></i>
                Procurement Plan Selection
            </h2>
        </div>
        <div style="padding: 1.25rem;">
            
            <!-- Planned vs Unplanned -->
            <div class="form-group">
                <label class="form-label">Requisition Type <span style="color: var(--danger-color);">*</span></label>
                <div class="radio-group">
                    <label class="radio-option active">
                        <input type="radio" name="is_planned" value="true" checked id="id_is_planned_yes">
                        <span>Planned (From Procurement Plan)</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="is_planned" value="false" id="id_is_planned_no">
                        <span>Unplanned/Emergency</span>
                    </label>
                </div>
            </div>

            <!-- Planned Requisition Section -->
            <div id="planned-section" style="margin-top: 1rem;">
                <div class="form-group">
                    <label class="form-label">{{ form.procurement_plan_item.label }} <span style="color: var(--danger-color);">*</span></label>
                    
                    {% if available_plan_items %}
                    <!-- Has Plan Items -->
                    <select class="form-control" name="procurement_plan_item" id="id_procurement_plan_item">
                        <option value="">-- Select Plan Item --</option>
                        {% for plan_item in available_plan_items %}
                        <option value="{{ plan_item.id }}" 
                                data-description="{{ plan_item.description }}"
                                data-cost="{{ plan_item.estimated_cost }}"
                                data-remaining="{{ plan_item.remaining_budget }}"
                                data-quantity="{{ plan_item.quantity }}"
                                data-uom="{{ plan_item.unit_of_measure }}"
                                data-quarter="{{ plan_item.get_planned_quarter_display }}"
                                data-method="{{ plan_item.get_procurement_method_display }}"
                                data-specifications="{{ plan_item.specifications }}"
                                {% if form.procurement_plan_item.value == plan_item.id|stringformat:"s" %}selected{% endif %}>
                            {{ plan_item.description|truncatewords:10 }} - 
                            {{ plan_item.get_planned_quarter_display }} - 
                            KES {{ plan_item.remaining_budget|floatformat:2|intcomma }} remaining
                        </option>
                        {% endfor %}
                    </select>
                    
                    {% else %}
                    <!-- No Plan Items -->
                    <div class="no-plan-items">
                        <strong><i class="bi bi-exclamation-triangle"></i> No Procurement Plan Items Available</strong>
                        <p>
                            {% if not user.department %}
                            <strong>Issue:</strong> You are not assigned to a department.<br>
                            <strong>Solution:</strong> Please contact your administrator to assign you to a department.
                            
                            {% elif not current_budget_year %}
                            <strong>Issue:</strong> No active budget year found.<br>
                            <strong>Solution:</strong> Please contact your administrator to activate a budget year.
                            
                            {% else %}
                            <strong>Issue:</strong> No approved procurement plan items found for <strong>{{ user.department.name }}</strong> in <strong>{{ current_budget_year.name }}</strong>.<br><br>
                            
                            <strong>To create plan items:</strong><br>
                            1. Go to Procurement Planning module<br>
                            2. Create a new procurement plan for your department<br>
                            3. Add items to the plan with specifications and budgets<br>
                            4. Submit the plan for approval<br>
                            5. Get HOD/Management to approve the plan<br>
                            6. Activate the approved plan<br><br>
                            
                            <strong>Alternatively:</strong> If this is a genuine emergency, select "Unplanned/Emergency" above to proceed without a plan item (requires special approval).
                            {% endif %}
                        </p>
                    </div>
                    
                    <select class="form-control" name="procurement_plan_item" id="id_procurement_plan_item" disabled>
                        <option value="">-- No Plan Items Available --</option>
                    </select>
                    {% endif %}
                    
                    {% if form.procurement_plan_item.errors %}
                    <div class="error-message">
                        {{ form.procurement_plan_item.errors }}
                    </div>
                    {% endif %}
                </div>

                <!-- Plan Item Details -->
                {% if available_plan_items %}
                <div class="plan-item-info" id="plan-item-info">
                    <strong style="font-size: 0.875rem; color: #1E293B;">
                        <i class="bi bi-clipboard-data"></i>
                        Plan Item Details
                    </strong>
                    <div class="plan-info-grid">
                        <div class="plan-info-item">
                            <span class="plan-info-label">Estimated Cost</span>
                            <span class="plan-info-value" id="plan-cost">-</span>
                        </div>
                        <div class="plan-info-item">
                            <span class="plan-info-label">Remaining Budget</span>
                            <span class="plan-info-value" id="plan-remaining">-</span>
                        </div>
                        <div class="plan-info-item">
                            <span class="plan-info-label">Planned Quarter</span>
                            <span class="plan-info-value" id="plan-quarter">-</span>
                        </div>
                        <div class="plan-info-item">
                            <span class="plan-info-label">Procurement Method</span>
                            <span class="plan-info-value" id="plan-method">-</span>
                        </div>
                        <div class="plan-info-item">
                            <span class="plan-info-label">Quantity</span>
                            <span class="plan-info-value" id="plan-quantity">-</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Unplanned/Emergency Section -->
            <div id="unplanned-section" style="margin-top: 1rem; display: none;">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <div>
                        <strong>Emergency Requisition</strong><br>
                        Unplanned requisitions require HOD emergency approval and procurement plan amendment. Please provide detailed justification.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">{{ form.emergency_type.label }} <span style="color: var(--danger-color);">*</span></label>
                    {{ form.emergency_type }}
                    {% if form.emergency_type.errors %}
                    <div class="error-message">
                        {{ form.emergency_type.errors }}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">{{ form.emergency_justification.label }} <span style="color: var(--danger-color);">*</span></label>
                    {{ form.emergency_justification }}
                    <small class="help-text">
                        Explain why this item was not planned and why it cannot wait until next quarter/year (minimum 50 characters)
                    </small>
                    {% if form.emergency_justification.errors %}
                    <div class="error-message">
                        {{ form.emergency_justification.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Basic Information -->
    <div class="table-card" style="margin-bottom: 1.5rem;">
        <div class="table-header">
            <h2 class="table-title">
                <i class="bi bi-info-circle"></i>
                Basic Information
            </h2>
        </div>
        <div style="padding: 1.25rem;">
            <div class="filter-grid">
                <div class="form-group">
                    <label class="form-label">{{ form.title.label }} <span style="color: var(--danger-color);">*</span></label>
                    {{ form.title }}
                    {% if form.title.errors %}
                    <div class="error-message">
                        {{ form.title.errors }}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label">{{ form.budget.label }} <span style="color: var(--danger-color);">*</span></label>
                    {{ form.budget }}
                    {% if form.budget.errors %}
                    <div class="error-message">
                        {{ form.budget.errors }}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label">{{ form.priority.label }} <span style="color: var(--danger-color);">*</span></label>
                    {{ form.priority }}
                    {% if form.priority.errors %}
                    <div class="error-message">
                        {{ form.priority.errors }}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label">{{ form.required_date.label }} <span style="color: var(--danger-color);">*</span></label>
                    {{ form.required_date }}
                    {% if form.required_date.errors %}
                    <div class="error-message">
                        {{ form.required_date.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label class="form-label">{{ form.justification.label }} <span style="color: var(--danger-color);">*</span></label>
                {{ form.justification }}
                {% if form.justification.errors %}
                <div class="error-message">
                    {{ form.justification.errors }}
                </div>
                {% endif %}
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label class="form-label">{{ form.notes.label }}</label>
                {{ form.notes }}
                {% if form.notes.errors %}
                <div class="error-message">
                    {{ form.notes.errors }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Requisition Items -->
    <div class="table-card" style="margin-bottom: 1.5rem;">
        <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="table-title">
                <i class="bi bi-list-ul"></i>
                Requisition Items <span style="color: var(--danger-color);">*</span>
            </h2>
            <button type="button" class="btn btn-primary btn-sm" id="add-item-btn">
                <i class="bi bi-plus-circle"></i>
                Add Item
            </button>
        </div>
        <div style="padding: 1.25rem;">
            {{ formset.management_form }}
            
            <div id="items-container">
                {% for item_form in formset %}
                <div class="item-form" data-form-index="{{ forloop.counter0 }}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>Item #<span class="item-number">{{ forloop.counter }}</span></h4>
                        <button type="button" class="btn btn-sm remove-item-btn" style="color: var(--danger-color);">
                            <i class="bi bi-trash"></i>
                            Remove
                        </button>
                    </div>

                    {{ item_form.id }}
                    {{ item_form.DELETE }}

                    <div class="filter-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Search Item from Catalog</label>
                            <div class="search-box">
                                <input type="text" class="form-control item-search" placeholder="Search by name or code...">
                                <i class="bi bi-search"></i>
                                <div class="search-results"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">{{ item_form.item.label }}</label>
                            {{ item_form.item }}
                            {% if item_form.item.errors %}
                            <div class="error-message">
                                {{ item_form.item.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label class="form-label">{{ item_form.unit_of_measure.label }} <span style="color: var(--danger-color);">*</span></label>
                            {{ item_form.unit_of_measure }}
                            {% if item_form.unit_of_measure.errors %}
                            <div class="error-message">
                                {{ item_form.unit_of_measure.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label class="form-label">{{ item_form.quantity.label }} <span style="color: var(--danger-color);">*</span></label>
                            {{ item_form.quantity }}
                            {% if item_form.quantity.errors %}
                            <div class="error-message">
                                {{ item_form.quantity.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label class="form-label">{{ item_form.estimated_unit_price.label }} <span style="color: var(--danger-color);">*</span></label>
                            {{ item_form.estimated_unit_price }}
                            {% if item_form.estimated_unit_price.errors %}
                            <div class="error-message">
                                {{ item_form.estimated_unit_price.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">{{ item_form.item_description.label }} <span style="color: var(--danger-color);">*</span></label>
                        {{ item_form.item_description }}
                        {% if item_form.item_description.errors %}
                        <div class="error-message">
                            {{ item_form.item_description.errors }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">{{ item_form.specifications.label }} <span style="color: var(--danger-color);">*</span></label>
                        {{ item_form.specifications }}
                        {% if item_form.specifications.errors %}
                        <div class="error-message">
                            {{ item_form.specifications.errors }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">{{ item_form.notes.label }}</label>
                        {{ item_form.notes }}
                        {% if item_form.notes.errors %}
                        <div class="error-message">
                            {{ item_form.notes.errors }}
                        </div>
                        {% endif %}
                    </div>

                    <div style="background: var(--hover-bg); padding: 0.75rem; border-radius: 0.375rem; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.875rem; font-weight: 500;">Item Total:</span>
                        <span class="item-total" style="font-size: 1rem; font-weight: 600; color: var(--primary-color);">KES 0.00</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="total-calculator">
                <span class="total-label">Total Estimated Amount:</span>
                <span class="total-amount" id="grand-total">KES 0.00</span>
            </div>
        </div>
    </div>

    <!-- Attachments -->
    <div class="table-card" style="margin-bottom: 1.5rem;">
        <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="table-title">
                <i class="bi bi-paperclip"></i>
                Supporting Documents (Optional)
            </h2>
            <button type="button" class="btn btn-primary btn-sm" id="add-attachment-btn">
                <i class="bi bi-plus-circle"></i>
                Add Document
            </button>
        </div>
        <div style="padding: 1.25rem;">
            {{ attachment_formset.management_form }}
            
            <div id="attachments-container">
                {% for attachment_form in attachment_formset %}
                <div class="attachment-form">
                    {{ attachment_form.id }}
                    {{ attachment_form.DELETE }}

                    <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                        <button type="button" class="btn btn-sm remove-attachment-btn" style="color: var(--danger-color);">
                            <i class="bi bi-trash"></i>
                            Remove
                        </button>
                    </div>

                    <div class="filter-grid">
                        <div class="form-group">
                            <label class="form-label">{{ attachment_form.attachment_type.label }}</label>
                            {{ attachment_form.attachment_type }}
                            {% if attachment_form.attachment_type.errors %}
                            <div class="error-message">
                                {{ attachment_form.attachment_type.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label class="form-label">{{ attachment_form.file_name.label }}</label>
                            {{ attachment_form.file_name }}
                            {% if attachment_form.file_name.errors %}
                            <div class="error-message">
                                {{ attachment_form.file_name.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label class="form-label">{{ attachment_form.file.label }}</label>
                            {{ attachment_form.file }}
                            {% if attachment_form.file.errors %}
                            <div class="error-message">
                                {{ attachment_form.file.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">{{ attachment_form.description.label }}</label>
                        {{ attachment_form.description }}
                        {% if attachment_form.description.errors %}
                        <div class="error-message">
                            {{ attachment_form.description.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-bottom: 2rem;">
        <a href="{% url 'staff_requisitions_list' %}" class="btn">
            <i class="bi bi-x-circle"></i>
            Cancel
        </a>
        <button type="submit" name="save_draft" class="btn">
            <i class="bi bi-save"></i>
            Save as Draft
        </button>
        <button type="submit" name="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i>
            {% if requisition %}Update{% else %}Create{% endif %} Requisition
        </button>
    </div>
</form>

<script>
// ============================================================================
// REQUISITION FORM DYNAMIC FUNCTIONALITY
// ============================================================================

(function() {
    'use strict';

    // Configuration
    const SEARCH_DELAY = 300; // milliseconds
    let searchTimeout = null;

    // ========================================================================
    // PLANNED VS UNPLANNED TOGGLE
    // ========================================================================
    
    function initializeRequisitionType() {
        const plannedSection = document.getElementById('planned-section');
        const unplannedSection = document.getElementById('unplanned-section');
        const planItemSelect = document.getElementById('id_procurement_plan_item');
        
        document.querySelectorAll('input[name="is_planned"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isPlanned = this.value === 'true';
                
                // Update radio option styling
                document.querySelectorAll('.radio-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.closest('.radio-option').classList.add('active');
                
                // Toggle sections with animation
                if (isPlanned) {
                    plannedSection.style.display = 'block';
                    unplannedSection.style.display = 'none';
                    if (planItemSelect) planItemSelect.required = true;
                } else {
                    plannedSection.style.display = 'none';
                    unplannedSection.style.display = 'block';
                    if (planItemSelect) planItemSelect.required = false;
                }
            });
        });
    }

    // ========================================================================
    // PLAN ITEM DETAILS DISPLAY
    // ========================================================================
    
    function initializePlanItemDetails() {
        const planItemSelect = document.getElementById('id_procurement_plan_item');
        const infoBox = document.getElementById('plan-item-info');
        
        if (!planItemSelect || !infoBox) return;
        
        planItemSelect.addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            
            if (this.value) {
                infoBox.classList.add('active');
                
                const cost = parseFloat(option.dataset.cost);
                const remaining = parseFloat(option.dataset.remaining);
                
                document.getElementById('plan-cost').textContent = 'KES ' + formatCurrency(cost);
                document.getElementById('plan-remaining').textContent = 'KES ' + formatCurrency(remaining);
                document.getElementById('plan-quarter').textContent = option.dataset.quarter;
                document.getElementById('plan-method').textContent = option.dataset.method;
                document.getElementById('plan-quantity').textContent = option.dataset.quantity + ' ' + option.dataset.uom;
                
                // Auto-populate first item if empty
                populateFromPlanItem(option);
            } else {
                infoBox.classList.remove('active');
            }
        });
        
        // Trigger on page load if already selected
        if (planItemSelect.value) {
            planItemSelect.dispatchEvent(new Event('change'));
        }
    }

    function populateFromPlanItem(option) {
        const firstItemForm = document.querySelector('.item-form');
        if (!firstItemForm) return;
        
        const descInput = firstItemForm.querySelector('[name$="item_description"]');
        const specInput = firstItemForm.querySelector('[name$="specifications"]');
        const uomInput = firstItemForm.querySelector('[name$="unit_of_measure"]');
        
        // Only populate if empty
        if (descInput && !descInput.value.trim()) {
            descInput.value = option.dataset.description || '';
        }
        if (specInput && !specInput.value.trim()) {
            specInput.value = option.dataset.specifications || '';
        }
        if (uomInput && !uomInput.value.trim()) {
            uomInput.value = option.dataset.uom || '';
        }
    }

    // ========================================================================
    // ITEM CATALOG SEARCH
    // ========================================================================
    
    function initializeItemSearch() {
        document.querySelectorAll('.item-search').forEach(searchInput => {
            const resultsDiv = searchInput.nextElementSibling.nextElementSibling;
            
            if (!resultsDiv) return;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    resultsDiv.classList.remove('active');
                    return;
                }
                
                resultsDiv.innerHTML = '<div class="loading-spinner"><i class="bi bi-hourglass-split"></i> Searching...</div>';
                resultsDiv.classList.add('active');
                
                searchTimeout = setTimeout(() => {
                    searchItems(query, resultsDiv, searchInput);
                }, SEARCH_DELAY);
            });
            
            // Close results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.classList.remove('active');
                }
            });
        });
    }

    function searchItems(query, resultsDiv, searchInput) {
        fetch(`/api/search-items/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.items && data.items.length > 0) {
                    resultsDiv.innerHTML = data.items.map(item => `
                        <div class="search-result-item" data-item='${JSON.stringify(item)}'>
                            <div class="search-result-name">${item.code} - ${item.name}</div>
                            <div class="search-result-details">
                                ${item.category} | ${item.unit_of_measure} | KES ${formatCurrency(parseFloat(item.standard_price))}
                            </div>
                        </div>
                    `).join('');
                    
                    // Add click handlers
                    resultsDiv.querySelectorAll('.search-result-item').forEach(itemDiv => {
                        itemDiv.addEventListener('click', function() {
                            const item = JSON.parse(this.dataset.item);
                            selectItem(item, searchInput);
                            resultsDiv.classList.remove('active');
                        });
                    });
                } else {
                    resultsDiv.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--secondary-color);">No items found</div>';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--danger-color);">Search failed. Please try again.</div>';
            });
    }

    function selectItem(item, searchInput) {
        const itemForm = searchInput.closest('.item-form');
        
        // Populate item select
        const itemSelect = itemForm.querySelector('[name$="item"]');
        if (itemSelect) {
            // Add option if doesn't exist
            let option = itemSelect.querySelector(`option[value="${item.id}"]`);
            if (!option) {
                option = new Option(`${item.code} - ${item.name}`, item.id, true, true);
                itemSelect.add(option);
            }
            itemSelect.value = item.id;
        }
        
        // Auto-fill fields
        const descInput = itemForm.querySelector('[name$="item_description"]');
        const specInput = itemForm.querySelector('[name$="specifications"]');
        const uomInput = itemForm.querySelector('[name$="unit_of_measure"]');
        const priceInput = itemForm.querySelector('[name$="estimated_unit_price"]');
        
        if (descInput) descInput.value = item.description;
        if (specInput) specInput.value = item.specifications || '';
        if (uomInput) uomInput.value = item.unit_of_measure;
        if (priceInput && item.standard_price) {
            priceInput.value = parseFloat(item.standard_price).toFixed(2);
            calculateItemTotal(itemForm);
        }
        
        searchInput.value = `${item.code} - ${item.name}`;
    }

    // ========================================================================
    // ITEM CALCULATION
    // ========================================================================
    
    function initializeCalculations() {
        document.querySelectorAll('.item-form').forEach(itemForm => {
            const qtyInput = itemForm.querySelector('[name$="quantity"]');
            const priceInput = itemForm.querySelector('[name$="estimated_unit_price"]');
            
            if (qtyInput) {
                qtyInput.addEventListener('input', () => calculateItemTotal(itemForm));
            }
            if (priceInput) {
                priceInput.addEventListener('input', () => calculateItemTotal(itemForm));
            }
        });
    }

    function calculateItemTotal(itemForm) {
        const qtyInput = itemForm.querySelector('[name$="quantity"]');
        const priceInput = itemForm.querySelector('[name$="estimated_unit_price"]');
        const totalSpan = itemForm.querySelector('.item-total');
        
        if (qtyInput && priceInput && totalSpan) {
            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = qty * price;
            
            totalSpan.textContent = 'KES ' + formatCurrency(total);
            calculateGrandTotal();
        }
    }

    function calculateGrandTotal() {
        let grandTotal = 0;
        
        document.querySelectorAll('.item-form').forEach(itemForm => {
            const deleteCheckbox = itemForm.querySelector('[name$="DELETE"]');
            if (deleteCheckbox && deleteCheckbox.checked) return;
            
            const qtyInput = itemForm.querySelector('[name$="quantity"]');
            const priceInput = itemForm.querySelector('[name$="estimated_unit_price"]');
            
            if (qtyInput && priceInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                grandTotal += qty * price;
            }
        });
        
        const grandTotalElement = document.getElementById('grand-total');
        if (grandTotalElement) {
            grandTotalElement.textContent = 'KES ' + formatCurrency(grandTotal);
        }
    }

    // ========================================================================
    // ADD/REMOVE ITEMS
    // ========================================================================
    
    function initializeAddRemoveItems() {
        const addBtn = document.getElementById('add-item-btn');
        const container = document.getElementById('items-container');
        const totalFormsInput = document.querySelector('[name$="TOTAL_FORMS"]');
        
        if (!addBtn || !container || !totalFormsInput) return;
        
        addBtn.addEventListener('click', function() {
            const formCount = parseInt(totalFormsInput.value);
            const newForm = createItemForm(formCount);
            
            container.insertAdjacentHTML('beforeend', newForm);
            totalFormsInput.value = formCount + 1;
            
            // Re-initialize for new form
            const newFormElement = container.lastElementChild;
            initializeItemSearchForForm(newFormElement);
            initializeCalculationsForForm(newFormElement);
            updateItemNumbers();
        });
        
        // Remove item handlers
        container.addEventListener('click', function(e) {
            if (e.target.closest('.remove-item-btn')) {
                const itemForm = e.target.closest('.item-form');
                const deleteCheckbox = itemForm.querySelector('[name$="DELETE"]');
                
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    itemForm.style.display = 'none';
                } else {
                    itemForm.remove();
                    totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
                }
                
                updateItemNumbers();
                calculateGrandTotal();
            }
        });
    }

    function createItemForm(index) {
        const prefix = 'items';
        return `
            <div class="item-form" data-form-index="${index}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4>Item #<span class="item-number">${index + 1}</span></h4>
                    <button type="button" class="btn btn-sm remove-item-btn" style="color: var(--danger-color);">
                        <i class="bi bi-trash"></i>
                        Remove
                    </button>
                </div>

                <input type="hidden" name="${prefix}-${index}-id">
                <input type="hidden" name="${prefix}-${index}-DELETE">

                <div class="filter-grid">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label">Search Item from Catalog</label>
                        <div class="search-box">
                            <input type="text" class="form-control item-search" placeholder="Search by name or code...">
                            <i class="bi bi-search"></i>
                            <div class="search-results"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Item (Optional)</label>
                        <select class="form-control" name="${prefix}-${index}-item">
                            <option value="">-- Select Item --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Unit of Measure <span style="color: var(--danger-color);">*</span></label>
                        <input type="text" class="form-control" name="${prefix}-${index}-unit_of_measure" placeholder="e.g., Units, Pieces">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Quantity <span style="color: var(--danger-color);">*</span></label>
                        <input type="number" class="form-control" name="${prefix}-${index}-quantity" step="0.01" min="0.01" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Estimated Unit Price <span style="color: var(--danger-color);">*</span></label>
                        <input type="number" class="form-control" name="${prefix}-${index}-estimated_unit_price" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">Item Description <span style="color: var(--danger-color);">*</span></label>
                    <textarea class="form-control" name="${prefix}-${index}-item_description" rows="2" placeholder="Describe the item..."></textarea>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">Specifications <span style="color: var(--danger-color);">*</span></label>
                    <textarea class="form-control" name="${prefix}-${index}-specifications" rows="3" placeholder="Technical specifications..."></textarea>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="form-control" name="${prefix}-${index}-notes" rows="2" placeholder="Additional notes..."></textarea>
                </div>

                <div style="background: var(--hover-bg); padding: 0.75rem; border-radius: 0.375rem; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.875rem; font-weight: 500;">Item Total:</span>
                    <span class="item-total" style="font-size: 1rem; font-weight: 600; color: var(--primary-color);">KES 0.00</span>
                </div>
            </div>
        `;
    }

    function initializeItemSearchForForm(formElement) {
        const searchInput = formElement.querySelector('.item-search');
        const resultsDiv = formElement.querySelector('.search-results');
        
        if (!searchInput || !resultsDiv) return;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                resultsDiv.classList.remove('active');
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading-spinner"><i class="bi bi-hourglass-split"></i> Searching...</div>';
            resultsDiv.classList.add('active');
            
            searchTimeout = setTimeout(() => {
                searchItems(query, resultsDiv, searchInput);
            }, SEARCH_DELAY);
        });
        
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.classList.remove('active');
            }
        });
    }

    function initializeCalculationsForForm(formElement) {
        const qtyInput = formElement.querySelector('[name$="quantity"]');
        const priceInput = formElement.querySelector('[name$="estimated_unit_price"]');
        
        if (qtyInput) {
            qtyInput.addEventListener('input', () => calculateItemTotal(formElement));
        }
        if (priceInput) {
            priceInput.addEventListener('input', () => calculateItemTotal(formElement));
        }
    }

    function updateItemNumbers() {
        let visibleIndex = 1;
        document.querySelectorAll('.item-form').forEach((form) => {
            const deleteCheckbox = form.querySelector('[name$="DELETE"]');
            if (!deleteCheckbox || !deleteCheckbox.checked) {
                const numberSpan = form.querySelector('.item-number');
                if (numberSpan) {
                    numberSpan.textContent = visibleIndex++;
                }
            }
        });
    }

    // ========================================================================
    // ADD/REMOVE ATTACHMENTS
    // ========================================================================

    function initializeAddRemoveAttachments() {
        const addBtn = document.getElementById('add-attachment-btn');
        const container = document.getElementById('attachments-container');
        const totalFormsInput = document.querySelector('[name$="attachments-TOTAL_FORMS"]');
        
        if (!addBtn || !container || !totalFormsInput) return;
        
        addBtn.addEventListener('click', function() {
            const formCount = parseInt(totalFormsInput.value);
            const newForm = createAttachmentForm(formCount);
            
            container.insertAdjacentHTML('beforeend', newForm);
            totalFormsInput.value = formCount + 1;
        });
        
        container.addEventListener('click', function(e) {
            if (e.target.closest('.remove-attachment-btn')) {
                const attachmentForm = e.target.closest('.attachment-form');
                const deleteCheckbox = attachmentForm.querySelector('[name$="DELETE"]');
                
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    attachmentForm.style.display = 'none';
                } else {
                    attachmentForm.remove();
                    totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
                }
            }
        });
    }

    function createAttachmentForm(index) {
        const prefix = 'attachments';
        return `
            <div class="attachment-form">
                <input type="hidden" name="${prefix}-${index}-id">
                <input type="hidden" name="${prefix}-${index}-DELETE">

                <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                    <button type="button" class="btn btn-sm remove-attachment-btn" style="color: var(--danger-color);">
                        <i class="bi bi-trash"></i>
                        Remove
                    </button>
                </div>

                <div class="filter-grid">
                    <div class="form-group">
                        <label class="form-label">Document Type</label>
                        <select class="form-control" name="${prefix}-${index}-attachment_type">
                            <option value="QUOTATION">Quotation</option>
                            <option value="TOR">Terms of Reference</option>
                            <option value="SPECIFICATION">Technical Specification</option>
                            <option value="JUSTIFICATION">Justification Document</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Document Name</label>
                        <input type="text" class="form-control" name="${prefix}-${index}-file_name" placeholder="Document name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">File</label>
                        <input type="file" class="form-control" name="${prefix}-${index}-file">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" name="${prefix}-${index}-description" rows="2" placeholder="Brief description..."></textarea>
                </div>
            </div>
        `;
    }

    // ========================================================================
    // UTILITY FUNCTIONS
    // ========================================================================

    function formatCurrency(amount) {
        return amount.toLocaleString('en-KE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // ========================================================================
    // INITIALIZATION
    // ========================================================================

    document.addEventListener('DOMContentLoaded', function() {
        initializeRequisitionType();
        initializePlanItemDetails();
        initializeItemSearch();
        initializeCalculations();
        initializeAddRemoveItems();
        initializeAddRemoveAttachments();
        
        // Initial calculation
        calculateGrandTotal();
    });
})();
</script>
{% endblock %}