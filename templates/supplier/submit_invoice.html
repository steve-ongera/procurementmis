{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Submit Invoice - University Procurement System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    :root {
        --primary-color: #2563EB;
        --primary-light: #EFF6FF;
        --primary-dark: #1D4ED8;
        --secondary-color: #64748B;
        --success-color: #10B981;
        --warning-color: #F59E0B;
        --danger-color: #EF4444;
        --border-color: #E2E8F0;
        --card-bg: #FFFFFF;
        --hover-bg: #F8FAFC;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #1E293B;
        margin: 0 0 0.5rem 0;
    }

    .page-subtitle {
        font-size: 1rem;
        color: var(--secondary-color);
        margin: 0;
    }

    /* Info Card */
    .info-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1E293B;
        margin: 0 0 1.5rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    .info-rows {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .info-row {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .info-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .info-value {
        font-size: 0.875rem;
        color: #334155;
        font-weight: 500;
    }

    /* Form Card */
    .form-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .card-header-with-action {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #475569;
    }

    .required {
        color: var(--danger-color);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea,
    select {
        padding: 0.625rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        transition: all 0.2s;
        font-family: inherit;
        background: var(--card-bg);
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    textarea {
        resize: vertical;
        min-height: 80px;
    }

    select {
        padding: 0.625rem 2.5rem 0.625rem 1rem;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748B' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.75rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .form-error {
        font-size: 0.75rem;
        color: var(--danger-color);
        margin-top: 0.25rem;
    }

    .help-text {
        font-size: 0.75rem;
        color: #64748B;
        margin: 0.5rem 0 0 0;
    }

    /* Items Table */
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 1.5rem;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
    }

    .items-table th {
        padding: 1rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--border-color);
        background: #F1F5F9;
        white-space: nowrap;
    }

    .items-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.875rem;
        color: #334155;
        vertical-align: middle;
    }

    .items-table tr:last-child td {
        border-bottom: none;
    }

    .items-table tr:hover {
        background: var(--hover-bg);
    }

    .items-table input[type="text"],
    .items-table input[type="number"],
    .items-table select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }

    .item-total {
        font-weight: 600;
        color: #1E293B;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid var(--border-color);
        cursor: pointer;
        background: var(--card-bg);
        color: var(--secondary-color);
    }

    .btn:hover {
        background: var(--hover-bg);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: var(--card-bg);
        color: var(--secondary-color);
        border-color: var(--border-color);
    }

    .btn-secondary:hover {
        background: #F1F5F9;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
    }

    .btn-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-icon.btn-danger {
        background: #FEF2F2;
        color: var(--danger-color);
        border-color: #FECACA;
    }

    .btn-icon.btn-danger:hover {
        background: #FECACA;
    }

    /* Totals Summary */
    .totals-summary {
        background: #F1F5F9;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }

    .totals-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .totals-row:last-child {
        border-bottom: none;
    }

    .totals-row.total {
        font-weight: 600;
        color: #1E293B;
        padding-top: 1rem;
        border-top: 2px solid var(--border-color);
        font-size: 1.125rem;
    }

    .totals-label {
        font-size: 0.875rem;
        color: #475569;
    }

    .totals-value {
        font-size: 0.875rem;
        color: #1E293B;
        font-weight: 600;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    .totals-row.total .totals-value {
        font-size: 1.125rem;
        color: var(--primary-color);
    }

    /* Documents Upload */
    .document-upload-row {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 1rem;
        align-items: end;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        background: #F8FAFC;
    }

    .document-upload-row:last-child {
        margin-bottom: 0;
    }

    input[type="file"].form-control {
        padding: 0.5rem;
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .form-actions .btn {
            width: 100%;
            justify-content: center;
        }
        
        .card-header-with-action {
            flex-direction: column;
            align-items: stretch;
        }
        
        .info-rows {
            grid-template-columns: 1fr;
        }
        
        .document-upload-row {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        .items-table th,
        .items-table td {
            padding: 0.75rem 0.5rem;
            font-size: 0.75rem;
        }
    }

    @media (max-width: 640px) {
        .btn {
            width: 100%;
            justify-content: center;
        }
        
        .form-card {
            padding: 1.5rem;
        }
        
        .info-card {
            padding: 1rem;
        }
        
        .items-table {
            display: block;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Submit Invoice</h1>
        <p class="page-subtitle">
            {% if po %}For Purchase Order: {{ po.po_number }}{% else %}Create a new invoice{% endif %}
        </p>
    </div>
    <a href="{% url 'supplier_invoices_list' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Invoices
    </a>
</div>

{% if po %}
<!-- PO Information -->
<div class="info-card">
    <h3 class="card-title">Purchase Order Information</h3>
    <div class="info-rows">
        <div class="info-row">
            <div class="info-label">PO Number:</div>
            <div class="info-value">{{ po.po_number }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">PO Date:</div>
            <div class="info-value">{{ po.po_date|date:"M d, Y" }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Department:</div>
            <div class="info-value">{{ po.requisition.department.name|truncatewords:3 }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Total Amount:</div>
            <div class="info-value">KES {{ po.total_amount|floatformat:2|intcomma }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Invoice Form -->
<form method="post" enctype="multipart/form-data" id="invoiceForm">
    {% csrf_token %}
    
    <div class="form-card">
        <h3 class="card-title">Invoice Details</h3>
        
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label" for="id_supplier_invoice_number">
                    Your Invoice Number <span class="required">*</span>
                </label>
                {{ invoice_form.supplier_invoice_number }}
                {% if invoice_form.supplier_invoice_number.errors %}
                <div class="form-error">{{ invoice_form.supplier_invoice_number.errors }}</div>
                {% endif %}
            </div>
            
            {% if not po %}
            <div class="form-group">
                <label class="form-label" for="id_purchase_order">
                    Purchase Order <span class="required">*</span>
                </label>
                {{ invoice_form.purchase_order }}
                {% if invoice_form.purchase_order.errors %}
                <div class="form-error">{{ invoice_form.purchase_order.errors }}</div>
                {% endif %}
            </div>
            {% endif %}
            
            <div class="form-group">
                <label class="form-label" for="id_invoice_date">
                    Invoice Date <span class="required">*</span>
                </label>
                {{ invoice_form.invoice_date }}
                {% if invoice_form.invoice_date.errors %}
                <div class="form-error">{{ invoice_form.invoice_date.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="id_due_date">
                    Due Date <span class="required">*</span>
                </label>
                {{ invoice_form.due_date }}
                {% if invoice_form.due_date.errors %}
                <div class="form-error">{{ invoice_form.due_date.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="id_other_charges">
                    Other Charges (if any)
                </label>
                {{ invoice_form.other_charges }}
                {% if invoice_form.other_charges.errors %}
                <div class="form-error">{{ invoice_form.other_charges.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="id_notes">
                Notes/Comments
            </label>
            {{ invoice_form.notes }}
            {% if invoice_form.notes.errors %}
            <div class="form-error">{{ invoice_form.notes.errors }}</div>
            {% endif %}
        </div>
    </div>
    
    <!-- Invoice Items -->
    <div class="form-card">
        <div class="card-header-with-action">
            <h3 class="card-title">Invoice Items</h3>
            <button type="button" class="btn btn-primary" onclick="addItem()">
                <i class="bi bi-plus-circle"></i> Add Item
            </button>
        </div>
        
        <div id="invoice-items">
            {{ item_formset.management_form }}
            
            <div class="table-responsive">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>PO Item</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Tax Rate (%)</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="items-tbody">
                        {% for form in item_formset %}
                        <tr class="item-row">
                            <td>
                                {{ form.po_item }}
                                {{ form.id }}
                            </td>
                            <td>
                                {{ form.description }}
                            </td>
                            <td>
                                {{ form.quantity }}
                            </td>
                            <td>
                                {{ form.unit_price }}
                            </td>
                            <td>
                                {{ form.tax_rate }}
                            </td>
                            <td>
                                <span class="item-total">0.00</span>
                            </td>
                            <td>
                                <button type="button" class="btn-icon btn-danger" onclick="removeItem(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Totals Summary -->
        <div class="totals-summary">
            <div class="totals-row">
                <span class="totals-label">Subtotal:</span>
                <span class="totals-value" id="subtotal">KES 0.00</span>
            </div>
            <div class="totals-row">
                <span class="totals-label">Tax:</span>
                <span class="totals-value" id="tax-total">KES 0.00</span>
            </div>
            <div class="totals-row">
                <span class="totals-label">Other Charges:</span>
                <span class="totals-value" id="other-charges">KES 0.00</span>
            </div>
            <div class="totals-row total">
                <span class="totals-label">Total Amount:</span>
                <span class="totals-value" id="grand-total">KES 0.00</span>
            </div>
        </div>
    </div>
    
    <!-- Supporting Documents -->
    <div class="form-card">
        <h3 class="card-title">Supporting Documents</h3>
        <p class="help-text">Upload supporting documents such as delivery notes, receipts, etc.</p>
        
        <div id="documents-container">
            <div class="document-upload-row">
                <div class="form-group">
                    <label class="form-label">Document Name</label>
                    <input type="text" name="doc_names" class="form-control" placeholder="e.g., Delivery Note">
                </div>
                <div class="form-group">
                    <label class="form-label">Choose File</label>
                    <input type="file" name="documents" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                </div>
                <button type="button" class="btn-icon btn-danger" onclick="removeDocument(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        
        <button type="button" class="btn btn-secondary" onclick="addDocument()">
            <i class="bi bi-plus-circle"></i> Add Another Document
        </button>
    </div>
    
    <!-- Form Actions -->
    <div class="form-actions">
        <a href="{% url 'supplier_invoices_list' %}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cancel
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-send"></i> Submit Invoice
        </button>
    </div>
</form>

<script>
// Item counter for dynamic forms
let itemCounter = {{ item_formset.total_form_count }};

// Calculate item totals
function calculateItemTotal(row) {
    const quantity = parseFloat(row.querySelector('[name*="quantity"]').value) || 0;
    const unitPrice = parseFloat(row.querySelector('[name*="unit_price"]').value) || 0;
    const taxRate = parseFloat(row.querySelector('[name*="tax_rate"]').value) || 0;
    
    const subtotal = quantity * unitPrice;
    const tax = subtotal * (taxRate / 100);
    const total = subtotal + tax;
    
    row.querySelector('.item-total').textContent = total.toFixed(2);
    
    calculateGrandTotal();
}

// Calculate grand total
function calculateGrandTotal() {
    let subtotal = 0;
    let taxTotal = 0;
    
    document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('[name*="quantity"]').value) || 0;
        const unitPrice = parseFloat(row.querySelector('[name*="unit_price"]').value) || 0;
        const taxRate = parseFloat(row.querySelector('[name*="tax_rate"]').value) || 0;
        
        const itemSubtotal = quantity * unitPrice;
        const itemTax = itemSubtotal * (taxRate / 100);
        
        subtotal += itemSubtotal;
        taxTotal += itemTax;
    });
    
    const otherCharges = parseFloat(document.querySelector('[name="other_charges"]').value) || 0;
    const grandTotal = subtotal + taxTotal + otherCharges;
    
    document.getElementById('subtotal').textContent = 'KES ' + subtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    document.getElementById('tax-total').textContent = 'KES ' + taxTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    document.getElementById('other-charges').textContent = 'KES ' + otherCharges.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    document.getElementById('grand-total').textContent = 'KES ' + grandTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Add item row
function addItem() {
    const tbody = document.getElementById('items-tbody');
    const newRow = tbody.querySelector('.item-row').cloneNode(true);
    
    // Clear values
    newRow.querySelectorAll('input, select').forEach(input => {
        if (input.name.includes('__prefix__')) {
            input.name = input.name.replace('__prefix__', itemCounter);
        }
        if (input.type !== 'hidden') {
            input.value = '';
        }
    });
    
    // Update ID for new row
    newRow.querySelector('.item-total').textContent = '0.00';
    tbody.appendChild(newRow);
    
    // Add event listeners
    newRow.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', () => calculateItemTotal(newRow));
    });
    
    itemCounter++;
    document.querySelector('[name$="TOTAL_FORMS"]').value = itemCounter;
}

// Remove item row
function removeItem(button) {
    if (document.querySelectorAll('.item-row').length > 1) {
        button.closest('.item-row').remove();
        calculateGrandTotal();
    } else {
        alert('You must have at least one item in the invoice.');
    }
}

// Add document upload row
function addDocument() {
    const container = document.getElementById('documents-container');
    const newRow = container.querySelector('.document-upload-row').cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => input.value = '');
    container.appendChild(newRow);
}

// Remove document upload row
function removeDocument(button) {
    if (document.querySelectorAll('.document-upload-row').length > 1) {
        button.closest('.document-upload-row').remove();
    }
}

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.item-row').forEach(row => {
        row.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', () => calculateItemTotal(row));
        });
    });
    
    document.querySelector('[name="other_charges"]').addEventListener('input', calculateGrandTotal);
    
    calculateGrandTotal();
});
</script>

{% endblock %}