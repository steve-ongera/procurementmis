{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}My Documents - University Procurement System{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Document Management</h1>
        <p class="page-subtitle">Upload and manage your compliance documents</p>
    </div>
    <button class="btn btn-primary" onclick="document.getElementById('uploadModal').style.display='flex'">
        <i class="bi bi-cloud-upload"></i> Upload Document
    </button>
</div>

<!-- Alerts for expiring/expired documents -->
{% if expired %}
<div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i>
    <div>
        <strong>Expired Documents!</strong>
        <p>You have {{ expired.count }} expired document{{ expired.count|pluralize }}. Please update them immediately.</p>
    </div>
</div>
{% endif %}

{% if expiring_soon %}
<div class="alert alert-warning">
    <i class="bi bi-clock"></i>
    <div>
        <strong>Documents Expiring Soon</strong>
        <p>{{ expiring_soon.count }} document{{ expiring_soon.count|pluralize }} will expire within the next 30 days.</p>
    </div>
</div>
{% endif %}

<!-- Document Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">
            <i class="bi bi-file-earmark-text"></i>
        </div>
        <div class="stat-value">{{ documents.count }}</div>
        <div class="stat-label">Total Documents</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon green">
            <i class="bi bi-check-circle"></i>
        </div>
        <div class="stat-value">{{ documents|selectattr:"is_verified"|list|length }}</div>
        <div class="stat-label">Verified</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon orange">
            <i class="bi bi-clock"></i>
        </div>
        <div class="stat-value">{{ expiring_soon.count }}</div>
        <div class="stat-label">Expiring Soon</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon red">
            <i class="bi bi-exclamation-triangle"></i>
        </div>
        <div class="stat-value">{{ expired.count }}</div>
        <div class="stat-label">Expired</div>
    </div>
</div>

<!-- Documents Table -->
<div class="table-card">
    <div class="table-header">
        <h2 class="table-title">
            <i class="bi bi-folder"></i>
            My Documents
        </h2>
    </div>
    
    <div class="table-body">
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Document Type</th>
                        <th>Document Name</th>
                        <th>Issue Date</th>
                        <th>Expiry Date</th>
                        <th>Status</th>
                        <th>Verification</th>
                        <th>Uploaded</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for document in documents %}
                    <tr>
                        <td>
                            <span class="badge badge-info">
                                {% if document.document_type == 'REGISTRATION' %}
                                <i class="bi bi-building"></i>
                                {% elif document.document_type == 'TAX' %}
                                <i class="bi bi-file-text"></i>
                                {% elif document.document_type == 'BANK' %}
                                <i class="bi bi-bank"></i>
                                {% elif document.document_type == 'LICENSE' %}
                                <i class="bi bi-award"></i>
                                {% elif document.document_type == 'INSURANCE' %}
                                <i class="bi bi-shield-check"></i>
                                {% else %}
                                <i class="bi bi-file"></i>
                                {% endif %}
                                {{ document.get_document_type_display }}
                            </span>
                        </td>
                        <td>{{ document.document_name }}</td>
                        <td>
                            {% if document.issue_date %}
                            {{ document.issue_date|date:"M d, Y" }}
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if document.expiry_date %}
                            {{ document.expiry_date|date:"M d, Y" }}
                            {% if document.expiry_date < today %}
                            <span class="badge badge-disputed">Expired</span>
                            {% elif document.expiry_date <= expiring_threshold %}
                            <span class="badge badge-warning">Expiring Soon</span>
                            {% endif %}
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if document.expiry_date %}
                                {% if document.expiry_date < today %}
                                <span class="badge badge-disputed">
                                    <i class="bi bi-x-circle"></i>
                                    Expired
                                </span>
                                {% elif document.expiry_date <= expiring_threshold %}
                                <span class="badge badge-warning">
                                    <i class="bi bi-clock"></i>
                                    Expiring
                                </span>
                                {% else %}
                                <span class="badge badge-paid">
                                    <i class="bi bi-check-circle"></i>
                                    Valid
                                </span>
                                {% endif %}
                            {% else %}
                            <span class="badge badge-draft">No Expiry</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if document.is_verified %}
                            <span class="badge badge-paid">
                                <i class="bi bi-check-circle"></i>
                                Verified
                            </span>
                            {% if document.verified_by %}
                            <small class="text-muted d-block">
                                by {{ document.verified_by.get_full_name }}
                            </small>
                            {% endif %}
                            {% else %}
                            <span class="badge badge-submitted">
                                <i class="bi bi-clock"></i>
                                Pending
                            </span>
                            {% endif %}
                        </td>
                        <td class="date-cell">{{ document.uploaded_at|date:"M d, Y" }}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="{{ document.file.url }}" class="action-btn action-btn-primary" 
                                   target="_blank" title="View Document">
                                    <i class="bi bi-eye"></i>
                                    View
                                </a>
                                <a href="{{ document.file.url }}" class="action-btn action-btn-info" 
                                   download title="Download">
                                    <i class="bi bi-download"></i>
                                    Download
                                </a>
                                <button class="action-btn action-btn-danger" 
                                        onclick="deleteDocument('{{ document.id }}')" title="Delete">
                                    <i class="bi bi-trash"></i>
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="bi bi-folder-x"></i>
                                <h4>No Documents Found</h4>
                                <p>You haven't uploaded any documents yet</p>
                                <button class="btn btn-primary" onclick="document.getElementById('uploadModal').style.display='flex'">
                                    <i class="bi bi-cloud-upload"></i> Upload Your First Document
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Required Documents Checklist -->
<div class="info-card">
    <h3 class="card-title">Required Documents Checklist</h3>
    <div class="checklist">
        <div class="checklist-item">
            <input type="checkbox" {% if documents|selectattr:"document_type","equalto","REGISTRATION"|list %}checked{% endif %} disabled>
            <label>
                <i class="bi bi-building"></i>
                <strong>Business Registration Certificate</strong>
                <small>Valid company registration document</small>
            </label>
        </div>
        <div class="checklist-item">
            <input type="checkbox" {% if documents|selectattr:"document_type","equalto","TAX"|list %}checked{% endif %} disabled>
            <label>
                <i class="bi bi-file-text"></i>
                <strong>Tax Compliance Certificate</strong>
                <small>Current tax clearance from KRA</small>
            </label>
        </div>
        <div class="checklist-item">
            <input type="checkbox" {% if documents|selectattr:"document_type","equalto","BANK"|list %}checked{% endif %} disabled>
            <label>
                <i class="bi bi-bank"></i>
                <strong>Bank Statement</strong>
                <small>Recent bank statement (last 3 months)</small>
            </label>
        </div>
        <div class="checklist-item">
            <input type="checkbox" {% if documents|selectattr:"document_type","equalto","LICENSE"|list %}checked{% endif %} disabled>
            <label>
                <i class="bi bi-award"></i>
                <strong>Professional License</strong>
                <small>Relevant professional licenses/permits</small>
            </label>
        </div>
        <div class="checklist-item">
            <input type="checkbox" {% if documents|selectattr:"document_type","equalto","INSURANCE"|list %}checked{% endif %} disabled>
            <label>
                <i class="bi bi-shield-check"></i>
                <strong>Insurance Certificate</strong>
                <small>Public liability or professional indemnity insurance</small>
            </label>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Document</h3>
            <button class="modal-close" onclick="document.getElementById('uploadModal').style.display='none'">
                <i class="bi bi-x"></i>
            </button>
        </div>
        
        <form method="post" enctype="multipart/form-data" action="{% url 'supplier_documents' %}">
            {% csrf_token %}
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="id_document_type">
                        Document Type <span class="required">*</span>
                    </label>
                    {{ form.document_type }}
                    {% if form.document_type.errors %}
                    <div class="form-error">{{ form.document_type.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="id_document_name">
                        Document Name <span class="required">*</span>
                    </label>
                    {{ form.document_name }}
                    {% if form.document_name.errors %}
                    <div class="form-error">{{ form.document_name.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="id_file">
                        Choose File <span class="required">*</span>
                    </label>
                    {{ form.file }}
                    <small class="help-text">Accepted formats: PDF, JPG, PNG (Max 5MB)</small>
                    {% if form.file.errors %}
                    <div class="form-error">{{ form.file.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="id_issue_date">
                            Issue Date
                        </label>
                        {{ form.issue_date }}
                        {% if form.issue_date.errors %}
                        <div class="form-error">{{ form.issue_date.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="id_expiry_date">
                            Expiry Date
                        </label>
                        {{ form.expiry_date }}
                        {% if form.expiry_date.errors %}
                        <div class="form-error">{{ form.expiry_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" 
                        onclick="document.getElementById('uploadModal').style.display='none'">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-cloud-upload"></i> Upload Document
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function deleteDocument(docId) {
    if (confirm('Are you sure you want to delete this document?')) {
        // Implement delete functionality
        // You'll need to create a delete view and handle this via AJAX or form submission
        alert('Delete functionality to be implemented');
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('uploadModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}
</script>

{% endblock %}