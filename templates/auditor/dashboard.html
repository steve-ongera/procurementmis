{% extends 'base.html' %}
{% load humanize %}

{% block title %}Auditor Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    :root {
        --primary-color: #2563EB;
        --primary-light: #EFF6FF;
        --success-color: #10B981;
        --warning-color: #F59E0B;
        --danger-color: #EF4444;
        --info-color: #6366F1;
        --secondary-color: #64748B;
        --border-color: #E2E8F0;
    }

    .dashboard-container {
        padding: 1.5rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 1.5rem;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0 0 0.5rem 0;
    }

    .page-subtitle {
        font-size: 0.875rem;
        color: var(--secondary-color);
    }

    /* Alert Banner */
    .alert-banner {
        background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
        border: 1px solid var(--warning-color);
        border-left: 4px solid var(--warning-color);
        border-radius: 0.5rem;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .alert-banner.danger {
        background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
        border-color: var(--danger-color);
    }

    .alert-icon {
        font-size: 1.5rem;
        color: var(--warning-color);
    }

    .alert-banner.danger .alert-icon {
        color: var(--danger-color);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.2s;
    }

    .stat-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .stat-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .stat-icon.primary { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); }
    .stat-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--success-color); }
    .stat-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
    .stat-icon.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger-color); }
    .stat-icon.info { background: rgba(99, 102, 241, 0.1); color: var(--info-color); }

    .stat-content {
        flex: 1;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--secondary-color);
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1E293B;
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .chart-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.25rem;
    }

    .chart-card.full-width {
        grid-column: 1 / -1;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    /* Activity Section */
    .activity-section {
        margin-top: 2rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .activity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .activity-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.25rem;
    }

    .activity-header {
        font-size: 1rem;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .activity-count {
        background: var(--primary-light);
        color: var(--primary-color);
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
    }

    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        padding: 0.75rem;
        border-radius: 0.375rem;
        background: #F8FAFC;
        border: 1px solid var(--border-color);
        transition: all 0.2s;
    }

    .activity-item:hover {
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .activity-item-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 0.5rem;
    }

    .activity-title {
        font-size: 0.875rem;
        font-weight: 500;
        color: #1E293B;
    }

    .activity-meta {
        font-size: 0.75rem;
        color: var(--secondary-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.75rem;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-emergency { background: #FEE2E2; color: #991B1B; }
    .status-single-bid { background: #FEF3C7; color: #92400E; }
    .status-overdue { background: #FEE2E2; color: #991B1B; }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--secondary-color);
        font-size: 0.875rem;
    }

    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#64748B';

    // Compliance Overview Donut Chart
    const complianceData = JSON.parse('{{ compliance_overview_chart|safe }}');
    const complianceCtx = document.getElementById('complianceChart');
    
    if (complianceCtx) {
        new Chart(complianceCtx, {
            type: 'doughnut',
            data: {
                labels: complianceData.labels,
                datasets: [{
                    data: complianceData.values,
                    backgroundColor: complianceData.colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, usePointStyle: true }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Risk Radar Chart
    const riskData = JSON.parse('{{ risk_radar_chart|safe }}');
    const riskCtx = document.getElementById('riskChart');
    
    if (riskCtx) {
        new Chart(riskCtx, {
            type: 'radar',
            data: {
                labels: riskData.labels,
                datasets: [{
                    label: 'Risk Level (%)',
                    data: riskData.values,
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderColor: '#EF4444',
                    borderWidth: 2,
                    pointBackgroundColor: '#EF4444',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: { color: '#F1F5F9' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Procurement Trend Line Chart
    const trendData = JSON.parse('{{ procurement_trend_chart|safe }}');
    const trendCtx = document.getElementById('trendChart');
    
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendData.labels,
                datasets: [
                    {
                        label: 'Requisitions',
                        data: trendData.requisitions,
                        borderColor: '#6366F1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Purchase Orders',
                        data: trendData.purchase_orders,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Payments',
                        data: trendData.payments,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true, padding: 15 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#F1F5F9' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Department Spending Bar Chart
    const deptData = JSON.parse('{{ dept_spending_chart|safe }}');
    const deptCtx = document.getElementById('deptChart');
    
    if (deptCtx) {
        new Chart(deptCtx, {
            type: 'bar',
            data: {
                labels: deptData.labels,
                datasets: [{
                    label: 'Spending (KES)',
                    data: deptData.values,
                    backgroundColor: '#2563EB',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'KES ' + context.parsed.y.toLocaleString();
                            },
                            afterLabel: function(context) {
                                return deptData.full_names[context.dataIndex];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + (value / 1000000).toFixed(1) + 'M';
                            }
                        },
                        grid: { color: '#F1F5F9' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-shield-check"></i>
            Auditor Dashboard
        </h1>
        <p class="page-subtitle">Procurement Compliance & Risk Monitoring</p>
    </div>

    <!-- Alert Banners -->
    {% if flagged_count > 10 %}
    <div class="alert-banner danger">
        <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
        <div>
            <strong>High Risk Alert:</strong> {{ flagged_count }} flagged transactions require immediate review.
        </div>
    </div>
    {% endif %}

    {% if budget_overruns|length > 0 %}
    <div class="alert-banner">
        <i class="bi bi-exclamation-circle-fill alert-icon"></i>
        <div>
            <strong>Budget Alert:</strong> {{ budget_overruns|length }} department(s) have exceeded their allocated budgets.
        </div>
    </div>
    {% endif %}

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="bi bi-file-earmark-text"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Total Requisitions</div>
                <div class="stat-value">{{ total_requisitions|intcomma }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="bi bi-exclamation-diamond"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Flagged Transactions</div>
                <div class="stat-value">{{ flagged_count }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon danger">
                <i class="bi bi-lightning"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Emergency Procurements</div>
                <div class="stat-value">{{ emergency_requisitions }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon info">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Pending Reviews</div>
                <div class="stat-value">{{ pending_reviews_count }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon success">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Budget Compliance</div>
                <div class="stat-value">{{ budget_compliance_rate }}%</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon success">
                <i class="bi bi-cash-coin"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Payment Compliance</div>
                <div class="stat-value">{{ payment_compliance_rate }}%</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="bi bi-award"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Total Tenders</div>
                <div class="stat-value">{{ total_tenders|intcomma }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon info">
                <i class="bi bi-file-earmark-ruled"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Active Contracts</div>
                <div class="stat-value">{{ total_contracts|intcomma }}</div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- Compliance Overview -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-pie-chart"></i>
                    Compliance Overview
                </h3>
            </div>
            <div class="chart-container">
                <canvas id="complianceChart"></canvas>
            </div>
        </div>

        <!-- Risk Indicators -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-radar"></i>
                    Risk Indicators
                </h3>
            </div>
            <div class="chart-container">
                <canvas id="riskChart"></canvas>
            </div>
        </div>

        <!-- Procurement Trend -->
        <div class="chart-card full-width">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-graph-up"></i>
                    Procurement Activity Trend (Last 6 Months)
                </h3>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Department Spending -->
        <div class="chart-card full-width">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-bar-chart"></i>
                    Top Spending Departments
                </h3>
            </div>
            <div class="chart-container">
                <canvas id="deptChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Activity Section -->
    <div class="activity-section">
        <h2 class="section-title">
            <i class="bi bi-activity"></i>
            Monitoring & Alerts
        </h2>

        <div class="activity-grid">
            <!-- Flagged Transactions -->
            <div class="activity-card">
                <div class="activity-header">
                    <span><i class="bi bi-flag"></i> Flagged Transactions</span>
                    <span class="activity-count">{{ flagged_items|length }}</span>
                </div>
                <div class="activity-list">
                    {% for item in flagged_items %}
                    <div class="activity-item">
                        <div class="activity-item-header">
                            <div class="activity-title">{{ item.reference }}</div>
                            <span class="status-badge status-{{ item.flag|lower|cut:" " }}">{{ item.flag }}</span>
                        </div>
                        <div class="activity-meta">
                            <span>{{ item.description|truncatechars:40 }}</span>
                            <span>•</span>
                            <span>KES {{ item.amount|floatformat:0|intcomma }}</span>
                            <span>•</span>
                            <span>{{ item.date|date:"M d, Y" }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="bi bi-check-circle"></i>
                        <p>No flagged transactions</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Pending Reviews -->
            <div class="activity-card">
                <div class="activity-header">
                    <span><i class="bi bi-eye"></i> High-Value Reviews</span>
                    <span class="activity-count">{{ pending_reviews|length }}</span>
                </div>
                <div class="activity-list">
                    {% for req in pending_reviews %}
                    <div class="activity-item">
                        <div class="activity-item-header">
                            <div class="activity-title">{{ req.requisition_number }}</div>
                        </div>
                        <div class="activity-meta">
                            <span>{{ req.title|truncatechars:35 }}</span>
                            <span>•</span>
                            <span>KES {{ req.estimated_amount|floatformat:0|intcomma }}</span>
                            <span>•</span>
                            <span>{{ req.department.code }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="bi bi-check-circle"></i>
                        <p>No pending reviews</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Compliance Alerts -->
            <div class="activity-card">
                <div class="activity-header">
                    <span><i class="bi bi-exclamation-triangle"></i> Compliance Alerts</span>
                    <span class="activity-count">
                        {{ budget_overruns|length|add:late_payments|length|add:expired_supplier_docs|length }}
                    </span>
                </div>
                <div class="activity-list">
                    {% for budget in budget_overruns %}
                    <div class="activity-item">
                        <div class="activity-item-header">
                            <div class="activity-title">Budget Overrun</div>
                        </div>
                        <div class="activity-meta">
                            <span>{{ budget.department.name }}</span>
                            <span>•</span>
                            <span>{{ budget.category.name }}</span>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% for payment in late_payments %}
                    <div class="activity-item">
                        <div class="activity-item-header">
                            <div class="activity-title">Late Payment</div>
                        </div>
                        <div class="activity-meta">
                            <span>{{ payment.invoice_number }}</span>
                            <span>•</span>
                            <span>Due: {{ payment.due_date|date:"M d" }}</span>
                        </div>
                    </div>
                    {% endfor %}

                    {% if not budget_overruns and not late_payments %}
                    <div class="empty-state">
                        <i class="bi bi-check-circle"></i>
                        <p>No compliance alerts</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Audit Activity -->
            <div class="activity-card">
                <div class="activity-header">
                    <span><i class="bi bi-clock-history"></i> Recent Activity</span>
                    <span class="activity-count">{{ recent_activities|length }}</span>
                </div>
                <div class="activity-list">
                    {% for activity in recent_activities %}
                    <div class="activity-item">
                        <div class="activity-item-header">
                            <div class="activity-title">{{ activity.get_action_display }} {{ activity.model_name }}</div>
                        </div>
                        <div class="activity-meta">
                            <span>{{ activity.user.get_full_name|default:activity.user.username }}</span>
                            <span>•</span>
                            <span>{{ activity.timestamp|timesince }} ago</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>No recent activity</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}