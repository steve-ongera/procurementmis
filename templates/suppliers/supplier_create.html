{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if supplier %}Edit Supplier{% else %}Create Supplier{% endif %} - University Procurement System
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
:root {
    --primary-color: #2563EB;
    --primary-light: #EFF6FF;
    --primary-dark: #1D4ED8;
    --secondary-color: #64748B;
    --success-color: #10B981;
    --warning-color: #F59E0B;
    --danger-color: #EF4444;
    --border-color: #E2E8F0;
    --card-bg: #FFFFFF;
    --hover-bg: #F8FAFC;
    --table-header: #F1F5F9;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.page-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: #1E293B;
    margin: 0 0 0.5rem 0;
}

.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--secondary-color);
    margin: 0;
}

.breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
    transition: color 0.2s;
}

.breadcrumb a:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

.breadcrumb i {
    font-size: 0.75rem;
    color: #94A3B8;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    border-radius: 0.375rem;
    font-weight: 500;
    font-size: 0.875rem;
    text-decoration: none;
    transition: all 0.2s;
    border: 1px solid var(--border-color);
    cursor: pointer;
    background: var(--card-bg);
    color: var(--secondary-color);
}

.btn:hover {
    background: var(--hover-bg);
    transform: translateY(-1px);
}

.btn-primary {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.btn-primary:hover {
    background: var(--primary-dark);
    border-color: var(--primary-dark);
}

.btn-secondary {
    background: #64748B;
    color: white;
    border-color: #64748B;
}

.btn-secondary:hover {
    background: #475569;
    border-color: #475569;
}

/* Form Card */
.form-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border-color);
}

.form-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.section-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1E293B;
    margin: 0 0 1.25rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.25rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
}

.form-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #475569;
}

.form-label.required::after {
    content: " *";
    color: var(--danger-color);
}

.form-control {
    padding: 0.625rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    transition: all 0.2s;
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

select.form-control {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2364748B' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.25rem;
    padding-right: 2.5rem;
}

textarea.form-control {
    min-height: 100px;
    resize: vertical;
}

.form-text {
    font-size: 0.75rem;
    color: #94A3B8;
    margin-top: 0.25rem;
}

/* Category Selection */
.category-selection {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-top: 0.5rem;
}

.category-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
}

.category-checkbox:hover {
    border-color: var(--primary-color);
    background: var(--primary-light);
}

.category-checkbox input[type="checkbox"] {
    margin: 0;
    cursor: pointer;
}

.category-checkbox label {
    cursor: pointer;
    font-size: 0.875rem;
    color: #334155;
    flex: 1;
    margin: 0;
}

/* Error Messages */
.error-message {
    color: var(--danger-color);
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
}

.alert-success {
    background-color: #D1FAE5;
    border: 1px solid #A7F3D0;
    color: #065F46;
}

.alert-danger {
    background-color: #FEF2F2;
    border: 1px solid #FECACA;
    color: #991B1B;
}

.alert-warning {
    background-color: #FEF3C7;
    border: 1px solid #FDE68A;
    color: #92400E;
}

.alert-info {
    background-color: #DBEAFE;
    border: 1px solid #BFDBFE;
    color: #1E40AF;
}

/* Form Actions */
.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding-top: 1.5rem;
    margin-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}

/* Readonly Fields */
.readonly-field {
    padding: 0.625rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    background: #F8FAFC;
    color: #64748B;
    font-size: 0.875rem;
}

/* Info Box */
.info-box {
    background: var(--primary-light);
    border: 1px solid var(--primary-color);
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.info-box-icon {
    color: var(--primary-color);
    font-size: 1.25rem;
    flex-shrink: 0;
}

.info-box-content {
    flex: 1;
}

.info-box-title {
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 0.25rem;
}

.info-box-text {
    font-size: 0.875rem;
    color: #1E40AF;
    margin: 0;
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .category-selection {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">
            {% if supplier %}
                <i class="bi bi-pencil"></i> Edit Supplier
            {% else %}
                <i class="bi bi-plus-circle"></i> Create New Supplier
            {% endif %}
        </h1>
        <div class="breadcrumb">
            <a href="{% url 'dashboard' %}"><i class="bi bi-house"></i>Home</a>
            <i class="bi bi-chevron-right"></i>
            <a href="{% url 'supplier_list' %}">Suppliers</a>
            <i class="bi bi-chevron-right"></i>
            <span>{% if supplier %}Edit{% else %}Create{% endif %}</span>
        </div>
    </div>
</div>

<!-- Display Messages -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- Info Box for New Supplier Creation -->
{% if not supplier %}
<div class="info-box">
    <i class="bi bi-info-circle-fill info-box-icon"></i>
    <div class="info-box-content">
        <div class="info-box-title">Automatic User Account Creation</div>
        <p class="info-box-text">
            When you create a new supplier, a user account will be automatically created for them. 
            Login credentials will be sent to the contact person's email address. 
            The supplier will be able to log in to the system and participate in the procurement process.
        </p>
    </div>
</div>
{% endif %}

<!-- Form Card -->
<div class="form-card">
    <form method="post" id="supplierForm">
        {% csrf_token %}
        
        <!-- Supplier Information Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-info-circle"></i>
                Supplier Information
            </h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Supplier Name</label>
                    <input type="text" name="name" class="form-control" 
                           value="{{ supplier.name|default:'' }}" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Registration Number</label>
                    <input type="text" name="registration_number" class="form-control" 
                           value="{{ supplier.registration_number|default:'' }}" required>
                    <small class="form-text">Official business registration number</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Tax ID</label>
                    <input type="text" name="tax_id" class="form-control" 
                           value="{{ supplier.tax_id|default:'' }}">
                    <small class="form-text">Tax identification number (optional)</small>
                </div>

                {% if supplier %}
                <div class="form-group">
                    <label class="form-label">Supplier Number</label>
                    <div class="readonly-field">{{ supplier.supplier_number }}</div>
                    <small class="form-text">System-generated unique identifier</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Contact Information Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-telephone"></i>
                Contact Information
            </h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Email Address</label>
                    <input type="email" name="email" class="form-control" 
                           value="{{ supplier.email|default:'' }}" required>
                    <small class="form-text">Primary company email</small>
                </div>

                <div class="form-group">
                    <label class="form-label required">Phone Number</label>
                    <input type="tel" name="phone_number" class="form-control" 
                           value="{{ supplier.phone_number|default:'' }}" required>
                    <small class="form-text">Primary contact number</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" name="website" class="form-control" 
                           value="{{ supplier.website|default:'' }}"
                           placeholder="https://example.com">
                    <small class="form-text">Include http:// or https://</small>
                </div>
            </div>
        </div>

        <!-- Address Information Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-geo-alt"></i>
                Address Information
            </h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Physical Address</label>
                    <textarea name="physical_address" class="form-control" rows="3" required>{{ supplier.physical_address|default:'' }}</textarea>
                    <small class="form-text">Street address, city, and country</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Postal Address</label>
                    <input type="text" name="postal_address" class="form-control" 
                           value="{{ supplier.postal_address|default:'' }}"
                           placeholder="P.O. Box 12345, City">
                    <small class="form-text">Mailing address (if different)</small>
                </div>
            </div>
        </div>

        <!-- Contact Person Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-person-lines-fill"></i>
                Contact Person Details
            </h3>
            
            {% if not supplier %}
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <i class="bi bi-envelope"></i> 
                <strong>Important:</strong> The contact person's email will receive the login credentials for accessing the procurement system.
            </div>
            {% endif %}
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Contact Person Name</label>
                    <input type="text" name="contact_person" class="form-control" 
                           value="{{ supplier.contact_person|default:'' }}" 
                           placeholder="Full Name" required>
                    <small class="form-text">Primary contact for procurement matters</small>
                </div>

                <div class="form-group">
                    <label class="form-label required">Contact Person Phone</label>
                    <input type="tel" name="contact_person_phone" class="form-control" 
                           value="{{ supplier.contact_person_phone|default:'' }}" required>
                    <small class="form-text">Direct phone number</small>
                </div>

                <div class="form-group">
                    <label class="form-label required">Contact Person Email</label>
                    <input type="email" name="contact_person_email" class="form-control" 
                           value="{{ supplier.contact_person_email|default:'' }}" required>
                    <small class="form-text">
                        {% if not supplier %}
                            <strong style="color: var(--warning-color);">
                                <i class="bi bi-exclamation-triangle"></i> Login credentials will be sent to this email
                            </strong>
                        {% else %}
                            Direct email address
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Bank Information Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-bank"></i>
                Bank Details
            </h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Bank Name</label>
                    <input type="text" name="bank_name" class="form-control" 
                           value="{{ supplier.bank_name|default:'' }}" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Bank Branch</label>
                    <input type="text" name="bank_branch" class="form-control" 
                           value="{{ supplier.bank_branch|default:'' }}" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Account Number</label>
                    <input type="text" name="account_number" class="form-control" 
                           value="{{ supplier.account_number|default:'' }}" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Account Name</label>
                    <input type="text" name="account_name" class="form-control" 
                           value="{{ supplier.account_name|default:'' }}" required>
                    <small class="form-text">Name as it appears on bank account</small>
                </div>

                <div class="form-group">
                    <label class="form-label">SWIFT Code</label>
                    <input type="text" name="swift_code" class="form-control" 
                           value="{{ supplier.swift_code|default:'' }}"
                           placeholder="XXXXXXXX or XXXXXXXXXXX">
                    <small class="form-text">For international payments (optional)</small>
                </div>
            </div>
        </div>

        <!-- Supplier Categories Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-tags"></i>
                Supplier Categories
            </h3>
            
            {% if categories %}
            <div class="category-selection">
                {% for category in categories %}
                <div class="category-checkbox">
                    <input type="checkbox" id="category-{{ category.id }}" 
                           name="categories" value="{{ category.id }}"
                           {% if supplier and category in supplier.categories.all %}checked{% endif %}>
                    <label for="category-{{ category.id }}">
                        {{ category.name }} ({{ category.code }})
                    </label>
                </div>
                {% endfor %}
            </div>
            <small class="form-text">Select all categories this supplier can provide goods/services for</small>
            {% else %}
            <p style="color: #94A3B8; margin: 0;">No categories available. Please contact administrator.</p>
            {% endif %}
        </div>

        <!-- Additional Information Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-sticky"></i>
                Additional Information
            </h3>
            
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea name="notes" class="form-control" rows="4" 
                          placeholder="Any additional information about this supplier...">{{ supplier.notes|default:'' }}</textarea>
                <small class="form-text">Internal notes, special instructions, or comments</small>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{% url 'supplier_list' %}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i>
                Cancel
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="bi bi-check-circle"></i>
                {% if supplier %}Update Supplier{% else %}Create Supplier & Send Credentials{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('supplierForm');
    const submitBtn = document.getElementById('submitBtn');
    
    // Form validation
    form.addEventListener('submit', function(e) {
        // Basic validation
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        let firstInvalidField = null;
        
        requiredFields.forEach(function(field) {
            if (!field.value.trim()) {
                isValid = false;
                field.style.borderColor = '#EF4444';
                if (!firstInvalidField) {
                    firstInvalidField = field;
                }
            } else {
                field.style.borderColor = '';
            }
        });
        
        if (!isValid && firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalidField.focus();
            e.preventDefault();
            return false;
        }
        
        // Email validation for contact emails
        const emailFields = form.querySelectorAll('input[type="email"]');
        let emailValid = true;
        
        emailFields.forEach(function(field) {
            if (field.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(field.value)) {
                emailValid = false;
                field.style.borderColor = '#EF4444';
                alert('Please enter a valid email address for ' + field.name.replace('_', ' '));
                field.focus();
            }
        });
        
        if (!emailValid) {
            e.preventDefault();
            return false;
        }
        
        // Website URL validation
        const websiteField = form.querySelector('input[name="website"]');
        if (websiteField && websiteField.value && !/^https?:\/\/.+/.test(websiteField.value)) {
            isValid = false;
            websiteField.style.borderColor = '#EF4444';
            alert('Please enter a valid website URL starting with http:// or https://');
            websiteField.focus();
            e.preventDefault();
            return false;
        }
        
        // Check if at least one category is selected (warning only)
        const categoryCheckboxes = form.querySelectorAll('input[name="categories"]:checked');
        if (categoryCheckboxes.length === 0) {
            const confirmed = confirm('No categories selected. Supplier will not be able to bid on any tenders. Continue anyway?');
            if (!confirmed) {
                e.preventDefault();
                return false;
            }
        }
        
        // Disable submit button to prevent double submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    });
    
    // Real-time validation for required fields
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(function(field) {
        field.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.style.borderColor = '#EF4444';
            } else {
                this.style.borderColor = '';
            }
        });
        
        field.addEventListener('input', function() {
            if (this.value.trim()) {
                this.style.borderColor = '';
            }
        });
    });
    
    // Format phone numbers (basic - remove non-digits)
    const phoneFields = form.querySelectorAll('input[type="tel"]');
    phoneFields.forEach(function(field) {
        field.addEventListener('input', function(e) {
            // Allow digits, spaces, hyphens, parentheses, and plus sign
            let value = e.target.value.replace(/[^\d\s\-\(\)\+]/g, '');
            e.target.value = value;
        });
    });
    
    // Email field validation on blur
    const emailFields = form.querySelectorAll('input[type="email"]');
    emailFields.forEach(function(field) {
        field.addEventListener('blur', function() {
            if (this.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.value)) {
                this.style.borderColor = '#EF4444';
            } else {
                this.style.borderColor = '';
            }
        });
        
        field.addEventListener('input', function() {
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.value)) {
                this.style.borderColor = '#F59E0B'; // Warning color
            } else {
                this.style.borderColor = '#10B981'; // Success color
            }
        });
    });
    
    // Highlight contact person email field for new suppliers
    {% if not supplier %}
    const contactPersonEmail = form.querySelector('input[name="contact_person_email"]');
    if (contactPersonEmail) {
        contactPersonEmail.addEventListener('focus', function() {
            this.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.2)';
        });
        
        contactPersonEmail.addEventListener('blur', function() {
            this.style.boxShadow = '';
        });
    }
    {% endif %}
    
    // Category selection counter
    const categoryCheckboxes = form.querySelectorAll('input[name="categories"]');
    const categorySection = form.querySelector('.category-selection');
    
    if (categoryCheckboxes.length > 0) {
        // Create counter element
        const counterDiv = document.createElement('div');
        counterDiv.style.cssText = 'margin-top: 0.75rem; font-size: 0.875rem; color: #64748B;';
        categorySection.parentNode.insertBefore(counterDiv, categorySection.nextSibling);
        
        function updateCounter() {
            const checked = form.querySelectorAll('input[name="categories"]:checked').length;
            counterDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${checked} categor${checked !== 1 ? 'ies' : 'y'} selected`;
            counterDiv.style.color = checked > 0 ? '#10B981' : '#94A3B8';
        }
        
        categoryCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', updateCounter);
        });
        
        updateCounter();
    }
});
</script>
{% endblock %}