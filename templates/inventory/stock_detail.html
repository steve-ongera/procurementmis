{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ stock.item.name }} - Stock Details{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>{{ stock.item.name }}</h1>
        <div class="breadcrumb">
            <a href="{% url 'dashboard' %}">Home</a>
            <span>/</span>
            <a href="{% url 'stock_list' %}">Stock Items</a>
            <span>/</span>
            <span>{{ stock.item.code }}</span>
        </div>
    </div>
    <div class="actions">
        {% if user.role in 'STORES,ADMIN' %}
        <a href="{% url 'stock_adjustment' stock.id %}" class="btn btn-primary">Adjust Stock</a>
        {% endif %}
        <a href="{% url 'stock_list' %}" class="btn">Back to List</a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Stock Information</h2>
    </div>
    <div class="card-body">
        <div class="info-grid">
            <div class="info-item">
                <label>Item Code</label>
                <p>{{ stock.item.code }}</p>
            </div>
            <div class="info-item">
                <label>Item Name</label>
                <p>{{ stock.item.name }}</p>
            </div>
            <div class="info-item">
                <label>Category</label>
                <p>{{ stock.item.category.name }}</p>
            </div>
            <div class="info-item">
                <label>Store</label>
                <p>{{ stock.store.name }}</p>
            </div>
            <div class="info-item">
                <label>Quantity on Hand</label>
                <p class="{% if stock.quantity_on_hand <= stock.reorder_level %}text-danger{% endif %}">
                    {{ stock.quantity_on_hand|floatformat:2 }} {{ stock.item.unit_of_measure }}
                </p>
            </div>
            <div class="info-item">
                <label>Reorder Level</label>
                <p>{{ stock.reorder_level|floatformat:2 }}</p>
            </div>
            <div class="info-item">
                <label>Average Unit Cost</label>
                <p>KES {{ stock.average_unit_cost|floatformat:2|intcomma }}</p>
            </div>
            <div class="info-item">
                <label>Total Value</label>
                <p>KES {{ stock.total_value|floatformat:0|intcomma }}</p>
            </div>
            <div class="info-item">
                <label>Last Restock Date</label>
                <p>{{ stock.last_restock_date|date:"M d, Y"|default:"-" }}</p>
            </div>
            <div class="info-item">
                <label>Last Issue Date</label>
                <p>{{ stock.last_issue_date|date:"M d, Y"|default:"-" }}</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Stock Movements (Last 50)</h2>
    </div>
    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Reference</th>
                    <th>Quantity</th>
                    <th>Balance Before</th>
                    <th>Balance After</th>
                    <th>Performed By</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
                {% for movement in movements %}
                <tr>
                    <td>{{ movement.movement_date|date:"M d, Y H:i" }}</td>
                    <td><span class="badge badge-{{ movement.movement_type|lower }}">{{ movement.get_movement_type_display }}</span></td>
                    <td>{{ movement.reference_number }}</td>
                    <td>{{ movement.quantity|floatformat:2 }}</td>
                    <td>{{ movement.balance_before|floatformat:2 }}</td>
                    <td>{{ movement.balance_after|floatformat:2 }}</td>
                    <td>{{ movement.performed_by.get_full_name }}</td>
                    <td>{{ movement.remarks|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center">No movements recorded</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Recent Issues</h2>
    </div>
    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <th>Issue Number</th>
                    <th>Department</th>
                    <th>Quantity Requested</th>
                    <th>Quantity Issued</th>
                    <th>Issue Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for issue_item in recent_issues %}
                <tr>
                    <td><a href="{% url 'issue_detail' issue_item.stock_issue.id %}">{{ issue_item.stock_issue.issue_number }}</a></td>
                    <td>{{ issue_item.stock_issue.department.name }}</td>
                    <td>{{ issue_item.quantity_requested|floatformat:2 }}</td>
                    <td>{{ issue_item.quantity_issued|floatformat:2 }}</td>
                    <td>{{ issue_item.stock_issue.issue_date|date:"M d, Y"|default:"-" }}</td>
                    <td><span class="badge badge-{{ issue_item.stock_issue.status|lower }}">{{ issue_item.stock_issue.get_status_display }}</span></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No recent issues</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}