{% extends 'base.html' %}
{% load humanize %}

{% block title %}Create Stock Issue{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Create Stock Issue</h1>
        <div class="breadcrumb">
            <a href="{% url 'dashboard' %}">Home</a>
            <span>/</span>
            <a href="{% url 'issue_list' %}">Stock Issues</a>
            <span>/</span>
            <span>Create</span>
        </div>
    </div>
</div>

<form method="post" id="issue-form">
    {% csrf_token %}
    
    <div class="card">
        <div class="card-header">
            <h2>Issue Details</h2>
        </div>
        <div class="card-body">
            <div class="form-grid">
                <div class="form-group">
                    <label>Store *</label>
                    <select name="store" id="store-select" required onchange="loadStockItems(this.value)">
                        <option value="">Select Store</option>
                        {% for store in stores %}
                        <option value="{{ store.id }}">{{ store.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Department *</label>
                    <select name="department" required>
                        <option value="">Select Department</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Purpose *</label>
                <textarea name="purpose" rows="3" required></textarea>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2>Items to Issue</h2>
            <button type="button" class="btn btn-sm" onclick="addItemRow()">Add Item</button>
        </div>
        <div class="card-body">
            <table id="items-table">
                <thead>
                    <tr>
                        <th>Stock Item</th>
                        <th>Available Qty</th>
                        <th>Quantity Requested</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="items-tbody">
                    <tr>
                        <td colspan="4" class="text-center">Select a store to load items</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="form-actions">
        <a href="{% url 'issue_list' %}" class="btn">Cancel</a>
        <button type="submit" class="btn btn-primary">Create Issue</button>
    </div>
</form>

<script>
let stockItems = [];

function loadStockItems(storeId) {
    if (!storeId) return;
    
    fetch(`/inventory/api/stock-items/${storeId}/`)
        .then(response => response.json())
        .then(data => {
            stockItems = data;
            document.getElementById('items-tbody').innerHTML = '';
            addItemRow();
        });
}

function addItemRow() {
    if (stockItems.length === 0) {
        alert('Please select a store first');
        return;
    }
    
    const tbody = document.getElementById('items-tbody');
    const row = tbody.insertRow();
    
    row.innerHTML = `
        <td>
            <select name="item_id[]" required onchange="updateAvailable(this)">
                <option value="">Select Item</option>
                ${stockItems.map(item => `
                    <option value="${item.id}" data-qty="${item.quantity_on_hand}">
                        ${item.item__name} (${item.item__code})
                    </option>
                `).join('')}
            </select>
        </td>
        <td class="available-qty">-</td>
        <td>
            <input type="number" name="quantity[]" step="0.01" min="0.01" required>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">Remove</button>
        </td>
    `;
}

function updateAvailable(select) {
    const option = select.options[select.selectedIndex];
    const qty = option.getAttribute('data-qty');
    select.closest('tr').querySelector('.available-qty').textContent = qty || '-';
}
</script>
{% endblock %}