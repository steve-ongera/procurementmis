{% extends 'base.html' %}
{% load humanize %}

{% block title %}Expenditure Analysis - University Procurement System{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    :root {
        --primary-color: #2563EB;
        --success-color: #059669;
        --warning-color: #D97706;
        --danger-color: #DC2626;
        --border-color: #E2E8F0;
        --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
    }

    .card-title {
        font-size: 18px;
        font-weight: 700;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chart-container {
        position: relative;
        height: 350px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: #F8FAFC;
    }

    th {
        padding: 16px;
        text-align: left;
        font-size: 12px;
        font-weight: 700;
        color: #475569;
        text-transform: uppercase;
        border-bottom: 2px solid var(--border-color);
    }

    td {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
    }

    tr:hover {
        background: #F8FAFC;
    }

    .progress-cell {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .progress-bar-mini {
        flex: 1;
        height: 8px;
        background: #F1F5F9;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        transition: width 0.3s;
    }

    .action-btn {
        padding: 10px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-secondary {
        background: white;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Expenditure Analysis</h1>
        <p style="color: #64748B; margin-top: 8px;">
            Detailed spending analysis for {{ current_year.name }}
        </p>
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="window.print()" class="action-btn btn-secondary">
            <i class="bi bi-printer"></i> Print Report
        </button>
        <a href="{% url 'financial_reports' %}" class="action-btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Monthly Trend Chart -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="bi bi-graph-up" style="color: var(--primary-color);"></i>
            Monthly Expenditure Trend
        </h2>
    </div>
    <div class="chart-container">
        <canvas id="trendChart"></canvas>
    </div>
</div>

<!-- Department Expenditure -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="bi bi-building" style="color: var(--success-color);"></i>
            Department Expenditure Analysis
        </h2>
    </div>
    
    {% if dept_expenditure %}
    <table>
        <thead>
            <tr>
                <th>Department</th>
                <th>Allocated</th>
                <th>Committed</th>
                <th>Spent</th>
                <th>Available</th>
                <th>Utilization</th>
            </tr>
        </thead>
        <tbody>
            {% for dept in dept_expenditure %}
            <tr>
                <td style="font-weight: 600;">{{ dept.department__name }}</td>
                <td>KES {{ dept.allocated|floatformat:0|intcomma }}</td>
                <td>KES {{ dept.committed|floatformat:0|intcomma }}</td>
                <td style="font-weight: 700; color: var(--danger-color);">
                    KES {{ dept.spent|floatformat:0|intcomma }}
                </td>
                <td style="color: var(--success-color); font-weight: 600;">
                    {% widthratio dept.spent dept.allocated 100 as spent_pct %}
                    KES {{ dept.allocated|sub:dept.spent|floatformat:0|intcomma }}
                </td>
                <td>
                    <div class="progress-cell">
                        {% widthratio dept.spent dept.allocated 100 as utilization %}
                        <div class="progress-bar-mini">
                            <div class="progress-fill" 
                                 style="width: {{ utilization }}%; background: {% if utilization > 80 %}var(--danger-color){% elif utilization > 60 %}var(--warning-color){% else %}var(--success-color){% endif %};">
                            </div>
                        </div>
                        <span style="font-size: 13px; font-weight: 700;">{{ utilization }}%</span>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot style="background: #F8FAFC; font-weight: 700;">
            <tr>
                <td>TOTAL</td>
                <td>KES {% widthratio dept_expenditure|length 1 1 as count %}{{ dept_expenditure.0.allocated|add:dept_expenditure.1.allocated|floatformat:0|intcomma }}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <p style="text-align: center; color: #94A3B8; padding: 40px;">
        No expenditure data available
    </p>
    {% endif %}
</div>

<!-- Category Expenditure -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="bi bi-tags" style="color: var(--warning-color);"></i>
            Category Expenditure Breakdown
        </h2>
    </div>
    
    {% if category_expenditure %}
    <table>
        <thead>
            <tr>
                <th>Category Code</th>
                <th>Category Name</th>
                <th>Allocated</th>
                <th>Spent</th>
                <th>Utilization</th>
            </tr>
        </thead>
        <tbody>
            {% for cat in category_expenditure %}
            <tr>
                <td style="font-family: monospace; font-weight: 600;">{{ cat.category__code }}</td>
                <td>{{ cat.category__name }}</td>
                <td>KES {{ cat.allocated|floatformat:0|intcomma }}</td>
                <td style="font-weight: 700;">KES {{ cat.spent|floatformat:0|intcomma }}</td>
                <td>
                    <div class="progress-cell">
                        {% widthratio cat.spent cat.allocated 100 as cat_util %}
                        <div class="progress-bar-mini">
                            <div class="progress-fill" 
                                 style="width: {{ cat_util }}%; background: var(--primary-color);">
                            </div>
                        </div>
                        <span style="font-size: 13px; font-weight: 700;">{{ cat_util }}%</span>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #94A3B8; padding: 40px;">
        No category data available
    </p>
    {% endif %}
</div>

<!-- Summary Statistics -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px;">
    <div class="card">
        <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: #1E293B; margin-bottom: 8px;">
                {{ dept_expenditure|length }}
            </div>
            <div style="font-size: 13px; font-weight: 600; color: #64748B;">
                Active Departments
            </div>
        </div>
    </div>
    
    <div class="card">
        <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: #1E293B; margin-bottom: 8px;">
                {{ category_expenditure|length }}
            </div>
            <div style="font-size: 13px; font-weight: 600; color: #64748B;">
                Budget Categories
            </div>
        </div>
    </div>
    
    <div class="card">
        <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: var(--primary-color); margin-bottom: 8px;">
                12
            </div>
            <div style="font-size: 13px; font-weight: 600; color: #64748B;">
                Months Analyzed
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Monthly Trend Chart
    const trendData = {{ monthly_data|safe }};
    const labels = trendData.map(item => item.month);
    const amounts = trendData.map(item => item.amount);

    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Expenditure (KES)',
                data: amounts,
                borderColor: '#2563EB',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: '#2563EB',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: (context) => `Spent: KES ${context.parsed.y.toLocaleString()}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: (value) => `KES ${(value/1000000).toFixed(1)}M`
                    }
                }
            }
        }
    });
</script>
{% endblock %}