{% extends 'base.html' %}
{% load custom_filters %}
{% load humanize %}

{% block title %}Make Payment - {{ invoice.invoice_number }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    :root {
        --primary-color: #2563EB;
        --primary-light: #EFF6FF;
        --primary-dark: #1D4ED8;
        --secondary-color: #64748B;
        --success-color: #10B981;
        --warning-color: #F59E0B;
        --danger-color: #EF4444;
        --border-color: #E2E8F0;
        --card-bg: #FFFFFF;
        --hover-bg: #F8FAFC;
        --table-header: #F1F5F9;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #1E293B;
        margin: 0 0 0.5rem 0;
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--secondary-color);
        margin: 0;
    }

    .breadcrumb a {
        color: var(--primary-color);
        text-decoration: none;
        transition: color 0.2s;
    }

    .breadcrumb a:hover {
        color: var(--primary-dark);
        text-decoration: underline;
    }

    .breadcrumb i {
        font-size: 0.75rem;
        color: #94A3B8;
    }

    /* Card Styles */
    .card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--table-header);
    }

    .card-header h2 {
        font-size: 1rem;
        font-weight: 600;
        color: #1E293B;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-header h2 i {
        color: var(--secondary-color);
        font-size: 1.125rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Info Grid */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin: 1rem 0;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    .info-label {
        font-size: 0.75rem;
        color: var(--secondary-color);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
    }

    .info-value {
        font-size: 0.875rem;
        color: #334155;
        font-weight: 500;
    }

    .amount-cell {
        font-weight: 600;
        color: #1E293B;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    /* Payment Summary */
    .payment-summary {
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: var(--hover-bg);
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .summary-row:last-child {
        border-bottom: none;
    }

    .summary-label {
        font-size: 0.875rem;
        color: #475569;
        font-weight: 500;
    }

    .summary-value {
        font-size: 0.875rem;
        color: #334155;
        font-weight: 600;
    }

    .total-row {
        padding: 1rem 0;
        border-top: 2px solid var(--border-color);
        margin-top: 0.5rem;
    }

    .total-row .summary-label {
        font-size: 1rem;
        font-weight: 600;
        color: #1E293B;
    }

    .total-row .summary-value {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--success-color);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    /* Alert Styles */
    .alert {
        padding: 1rem 1.25rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        border: 1px solid;
    }

    .alert-info {
        background: #F0F9FF;
        border-color: #BAE6FD;
        color: #0C4A6E;
    }

    .alert-warning {
        background: #FFFBEB;
        border-color: #FDE68A;
        color: #92400E;
    }

    .alert-success {
        background: #F0FDF4;
        border-color: #A7F3D0;
        color: #047857;
    }

    .alert i {
        font-size: 1.25rem;
        flex-shrink: 0;
        margin-top: 0.125rem;
    }

    .alert p {
        margin: 0;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    /* Form Grid */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    @media (min-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .form-group-full {
            grid-column: 1 / -1;
        }
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #475569;
    }

    .required {
        color: var(--danger-color);
        margin-left: 0.125rem;
    }

    .form-control,
    .form-select {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #334155;
        background: white;
        transition: all 0.2s;
    }

    .form-control:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-control::placeholder {
        color: #94A3B8;
    }

    textarea.form-control {
        min-height: 80px;
        resize: vertical;
        line-height: 1.5;
    }

    .form-help {
        display: block;
        margin-top: 0.375rem;
        font-size: 0.75rem;
        color: var(--secondary-color);
    }

    /* Date Input Styling */
    .date-input {
        position: relative;
    }

    .date-input .form-control {
        padding-right: 2.5rem;
    }

    .date-input::after {
        content: '\F4E6';
        font-family: 'bootstrap-icons';
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        pointer-events: none;
    }

    /* Payment Status */
    .payment-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .status-pending {
        background: #FEF3C7;
        color: #92400E;
        border: 1px solid #FDE68A;
    }

    .status-approved {
        background: #D1FAE5;
        color: #047857;
        border: 1px solid #A7F3D0;
    }

    .status-paid {
        background: #D1FAE5;
        color: #047857;
        border: 1px solid #A7F3D0;
    }

    .status-overdue {
        background: #FEE2E2;
        color: #B91C1C;
        border: 1px solid #FECACA;
    }

    /* Button Styles */
    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid transparent;
        cursor: pointer;
        white-space: nowrap;
    }

    .btn-secondary {
        background: white;
        color: #475569;
        border-color: var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--hover-bg);
        border-color: #CBD5E1;
        transform: translateY(-1px);
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
        transform: translateY(-1px);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }

    .btn-success:hover {
        background: #059669;
        border-color: #059669;
        transform: translateY(-1px);
    }

    /* Loading State */
    .btn-loading {
        position: relative;
        color: transparent !important;
    }

    .btn-loading::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 640px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        
        .form-actions {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        
        .form-actions .btn {
            width: 100%;
            justify-content: center;
        }
        
        .summary-row {
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .summary-value {
            text-align: right;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Make Payment</h1>
        <div class="breadcrumb">
            <a href="{% url 'dashboard' %}">
                <i class="bi bi-house"></i>
                Home
            </a>
            <i class="bi bi-chevron-right"></i>
            <a href="{% url 'invoice_list' %}">Invoices</a>
            <i class="bi bi-chevron-right"></i>
            <a href="{% url 'invoice_detail' invoice.id %}">{{ invoice.invoice_number }}</a>
            <i class="bi bi-chevron-right"></i>
            <span>Make Payment</span>
        </div>
    </div>
</div>

<form method="post" id="paymentForm">
    {% csrf_token %}
    
    <!-- Invoice Summary Card -->
    <div class="card">
        <div class="card-header">
            <h2><i class="bi bi-receipt"></i> Invoice Summary</h2>
        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Invoice Number</span>
                    <span class="info-value">{{ invoice.invoice_number }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Supplier</span>
                    <span class="info-value">{{ invoice.supplier.name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Invoice Date</span>
                    <span class="info-value">{{ invoice.invoice_date|date:"M d, Y" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Due Date</span>
                    <span class="info-value">{{ invoice.due_date|date:"M d, Y" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Current Status</span>
                    <span class="payment-status status-{{ invoice.status|lower }}">
                        {{ invoice.get_status_display }}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Days Until Due</span>
                    <span class="info-value">
                        {% if days_until_due > 0 %}
                            {{ days_until_due }} day(s)
                        {% elif days_until_due == 0 %}
                            Due Today
                        {% else %}
                            Overdue by {{ days_until_due|abs }} day(s)
                        {% endif %}
                    </span>
                </div>
            </div>
            
            <div class="payment-summary">
                <div class="summary-row">
                    <span class="summary-label">Total Invoice Amount:</span>
                    <span class="summary-value amount-cell">KES {{ invoice.total_amount|floatformat:2|intcomma }}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Paid:</span>
                    <span class="summary-value amount-cell">KES {{ total_paid|floatformat:2|intcomma }}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Previous Payments:</span>
                    <span class="summary-value">{{ invoice.payments.count }}</span>
                </div>
                <div class="summary-row total-row">
                    <span class="summary-label">Remaining Balance:</span>
                    <span class="summary-value amount-cell">KES {{ remaining_balance|floatformat:2|intcomma }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Details Card -->
    <div class="card">
        <div class="card-header">
            <h2><i class="bi bi-cash-stack"></i> Payment Details</h2>
        </div>
        <div class="card-body">
            {% if days_until_due < 0 %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <div>
                    <strong>Invoice Overdue:</strong> This invoice is overdue by {{ days_until_due|abs }} day(s). 
                    Consider prioritizing this payment.
                </div>
            </div>
            {% endif %}
            
            {% if invoice.status == 'APPROVED' %}
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i>
                <div>
                    <strong>Ready for Payment:</strong> This invoice has been approved and is ready for payment processing.
                </div>
            </div>
            {% endif %}
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <div>
                    <strong>Partial Payments:</strong> You can make a partial payment if needed. The remaining balance will be available for future payments.
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">
                        Payment Date
                        <span class="required">*</span>
                    </label>
                    <div class="date-input">
                        <input type="date" 
                               name="payment_date" 
                               id="payment_date"
                               class="form-control" 
                               value="{{ today|date:'Y-m-d' }}"
                               max="{{ today|date:'Y-m-d' }}"
                               required>
                    </div>
                    <span class="form-help">Payment date cannot be in the future</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Payment Amount (KES)
                        <span class="required">*</span>
                    </label>
                    <input type="number" 
                           name="payment_amount" 
                           class="form-control" 
                           step="0.01"
                           min="0.01"
                           max="{{ remaining_balance }}"
                           value="{{ remaining_balance }}"
                           required
                           id="payment-amount">
                    <span class="form-help">Maximum: KES {{ remaining_balance|floatformat:2|intcomma }}</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Payment Method
                        <span class="required">*</span>
                    </label>
                    <select name="payment_method" class="form-select" required id="payment-method">
                        <option value="">Select Payment Method</option>
                        {% for value, label in payment_methods %}
                        <option value="{{ value }}" {% if value == 'BANK_TRANSFER' %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Payment Reference
                        <span class="required">*</span>
                    </label>
                    <input type="text" 
                           name="payment_reference" 
                           id="payment_reference"
                           class="form-control" 
                           required
                           placeholder="e.g., Transaction ID, Receipt Number">
                    <span class="form-help">Unique identifier for this payment</span>
                </div>
                
                <!-- Dynamic Fields based on Payment Method -->
                <div class="form-group" id="bank-name-group" style="display: none;">
                    <label class="form-label">Bank Name</label>
                    <input type="text" 
                           name="bank_name" 
                           id="bank_name"
                           class="form-control"
                           placeholder="Enter bank name (e.g., Equity Bank, KCB)">
                </div>
                
                <div class="form-group" id="cheque-number-group" style="display: none;">
                    <label class="form-label">Cheque Number</label>
                    <input type="text" 
                           name="cheque_number" 
                           id="cheque_number"
                           class="form-control"
                           placeholder="Enter cheque number">
                </div>
                
                <div class="form-group" id="transaction-date-group" style="display: none;">
                    <label class="form-label">Transaction Date</label>
                    <div class="date-input">
                        <input type="date" 
                               name="transaction_date" 
                               id="transaction_date"
                               class="form-control"
                               value="{{ today|date:'Y-m-d' }}">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Payment Notes</label>
                <textarea name="notes" 
                          id="payment_notes"
                          class="form-control" 
                          rows="3"
                          placeholder="Additional notes about this payment..."></textarea>
                <span class="form-help">Optional notes for internal reference</span>
            </div>
        </div>
    </div>
    
    <!-- Supplier Bank Details Card -->
    {% if invoice.supplier.bank_name or invoice.supplier.account_number %}
    <div class="card">
        <div class="card-header">
            <h2><i class="bi bi-bank"></i> Supplier Bank Details</h2>
        </div>
        <div class="card-body">
            <div class="info-grid">
                {% if invoice.supplier.bank_name %}
                <div class="info-item">
                    <span class="info-label">Bank Name</span>
                    <span class="info-value">{{ invoice.supplier.bank_name }}</span>
                </div>
                {% endif %}
                
                {% if invoice.supplier.bank_branch %}
                <div class="info-item">
                    <span class="info-label">Branch</span>
                    <span class="info-value">{{ invoice.supplier.bank_branch }}</span>
                </div>
                {% endif %}
                
                {% if invoice.supplier.account_number %}
                <div class="info-item">
                    <span class="info-label">Account Number</span>
                    <span class="info-value">{{ invoice.supplier.account_number }}</span>
                </div>
                {% endif %}
                
                {% if invoice.supplier.account_name %}
                <div class="info-item">
                    <span class="info-label">Account Name</span>
                    <span class="info-value">{{ invoice.supplier.account_name }}</span>
                </div>
                {% endif %}
                
                {% if invoice.supplier.swift_code %}
                <div class="info-item">
                    <span class="info-label">SWIFT Code</span>
                    <span class="info-value">{{ invoice.supplier.swift_code }}</span>
                </div>
                {% endif %}
                
                {% if invoice.supplier.bank_code %}
                <div class="info-item">
                    <span class="info-label">Bank Code</span>
                    <span class="info-value">{{ invoice.supplier.bank_code }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Form Actions -->
    <div class="form-actions">
        <a href="{% url 'invoice_detail' invoice.id %}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i>
            Cancel
        </a>
        <button type="submit" class="btn btn-success" id="submitBtn">
            <i class="bi bi-check-circle"></i>
            Create Payment
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('paymentForm');
    const submitBtn = document.getElementById('submitBtn');
    const paymentMethod = document.getElementById('payment-method');
    const paymentAmount = document.getElementById('payment-amount');
    
    // Safely get remaining balance
    const remainingBalance = parseFloat('{{ remaining_balance|default:0 }}') || 0;
    const invoiceNumber = '{{ invoice.invoice_number|escapejs }}';
    const daysUntilDue = parseInt('{{ days_until_due|default:0 }}') || 0;
    
    // Show/hide fields based on payment method
    function togglePaymentFields() {
        const method = paymentMethod.value;
        const bankGroup = document.getElementById('bank-name-group');
        const chequeGroup = document.getElementById('cheque-number-group');
        const transactionGroup = document.getElementById('transaction-date-group');
        
        if (method === 'BANK_TRANSFER' || method === 'EFT') {
            bankGroup.style.display = 'block';
            chequeGroup.style.display = 'none';
            transactionGroup.style.display = 'block';
        } else if (method === 'CHEQUE') {
            bankGroup.style.display = 'block';
            chequeGroup.style.display = 'block';
            transactionGroup.style.display = 'none';
        } else if (method === 'CASH') {
            bankGroup.style.display = 'none';
            chequeGroup.style.display = 'none';
            transactionGroup.style.display = 'none';
        } else {
            bankGroup.style.display = 'none';
            chequeGroup.style.display = 'none';
            transactionGroup.style.display = 'none';
        }
    }
    
    // Initialize payment method fields
    togglePaymentFields();
    paymentMethod.addEventListener('change', togglePaymentFields);
    
    // Auto-generate payment reference
    function generatePaymentReference() {
        const method = paymentMethod.value;
        const invoiceRef = '{{ invoice.invoice_number|slice:"-6:" }}';
        const date = new Date().toISOString().slice(2, 10).replace(/-/g, '');
        let prefix = 'PAY';
        
        if (method === 'BANK_TRANSFER') prefix = 'BT';
        else if (method === 'CHEQUE') prefix = 'CHQ';
        else if (method === 'CASH') prefix = 'CSH';
        else if (method === 'MPESA') prefix = 'MP';
        
        const reference = `${prefix}${date}${invoiceRef}`;
        document.getElementById('payment_reference').value = reference;
    }
    
    // Generate reference on load and when payment method changes
    generatePaymentReference();
    paymentMethod.addEventListener('change', generatePaymentReference);
    
    // Form validation
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate payment amount
            const amount = parseFloat(paymentAmount.value) || 0;
            
            if (amount <= 0) {
                alert('Payment amount must be greater than zero');
                paymentAmount.focus();
                return;
            }
            
            if (amount > remainingBalance) {
                alert(`Payment amount cannot exceed the remaining balance of KES ${remainingBalance.toLocaleString('en-KE', {minimumFractionDigits: 2})}`);
                paymentAmount.focus();
                return;
            }
            
            // Validate payment method
            if (!paymentMethod.value) {
                alert('Please select a payment method');
                paymentMethod.focus();
                return;
            }
            
            // Validate payment reference
            const paymentRef = document.getElementById('payment_reference').value.trim();
            if (!paymentRef) {
                alert('Please enter a payment reference');
                document.getElementById('payment_reference').focus();
                return;
            }
            
            // Check if this is a full or partial payment
            const isFullPayment = Math.abs(amount - remainingBalance) < 0.01;
            let confirmationMessage = '';
            
            if (isFullPayment) {
                confirmationMessage = `Process full payment of KES ${amount.toLocaleString()} for invoice ${invoiceNumber}?`;
            } else {
                confirmationMessage = `Process partial payment of KES ${amount.toLocaleString()} for invoice ${invoiceNumber}?\n\nRemaining balance: KES ${(remainingBalance - amount).toLocaleString()}`;
            }
            
            // Add overdue warning if applicable
            if (daysUntilDue < 0) {
                confirmationMessage += `\n\nâš  This invoice is overdue by ${Math.abs(daysUntilDue)} day(s).`;
            }
            
            confirmationMessage += `\n\nThis action cannot be undone.`;
            
            if (confirm(confirmationMessage)) {
                submitBtn.classList.add('btn-loading');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass"></i> Processing...';
                form.submit();
            }
        });
    }
    
    // Set payment date max to today
    const paymentDateInput = document.getElementById('payment_date');
    const today = new Date().toISOString().split('T')[0];
    if (paymentDateInput) {
        paymentDateInput.max = today;
    }
    
    // Set transaction date to today by default
    const transactionDateInput = document.getElementById('transaction_date');
    if (transactionDateInput) {
        transactionDateInput.value = today;
    }
    
    // Keyboard shortcut for submission (Ctrl/Cmd + Enter)
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && form) {
            e.preventDefault();
            submitBtn.click();
        }
    });
});
</script>
{% endblock %}