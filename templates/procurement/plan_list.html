{% extends 'base.html' %}
{% load humanize %}

{% block title %}Procurement Plans - Procurement Module{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">{{ page_title }}</h1>
        <div class="breadcrumb">
            <a href="{% url 'procurement_dashboard' %}">
                <i class="bi bi-house"></i>
                Dashboard
            </a>
            <i class="bi bi-chevron-right"></i>
            <span>Procurement Plans</span>
        </div>
    </div>
    <div class="header-actions">
        <a href="{% url 'procurement_plan_create' %}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i>
            Create Procurement Plan
        </a>
        <a href="{% url 'procurement_plan_reports' %}" class="btn">
            <i class="bi bi-graph-up"></i>
            Reports
        </a>
        <a href="{% url 'plan_amendment_list' %}" class="btn">
            <i class="bi bi-pencil-square"></i>
            Amendments
        </a>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-info">
                <h3>{{ total_plans|intcomma }}</h3>
                <p>Total Plans</p>
            </div>
            <div class="stat-icon">
                <i class="bi bi-file-earmark-text"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-info">
                <h3>{{ approved_plans|intcomma }}</h3>
                <p>Approved Plans</p>
            </div>
            <div class="stat-icon">
                <i class="bi bi-check-circle"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-info">
                <h3>{{ active_plans|intcomma }}</h3>
                <p>Active Plans</p>
            </div>
            <div class="stat-icon">
                <i class="bi bi-play-circle"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-info">
                <h3>{{ draft_plans|intcomma }}</h3>
                <p>Draft Plans</p>
            </div>
            <div class="stat-icon">
                <i class="bi bi-file-earmark"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filter Card -->
<div class="filter-card">
    <h3 class="filter-title">
        <i class="bi bi-funnel"></i>
        Filter Procurement Plans
    </h3>
    
    <form method="get" class="filter-form">
        <div class="filter-group">
            <label class="filter-label">Budget Year</label>
            <select name="budget_year" class="filter-select">
                <option value="">All Years</option>
                {% for year in budget_years %}
                <option value="{{ year.id }}" {% if selected_budget_year == year.id|stringformat:"s" %}selected{% endif %}>
                    {{ year.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Department</label>
            <select name="department" class="filter-select">
                <option value="">All Departments</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>
                    {{ dept.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Status</label>
            <select name="status" class="filter-select">
                <option value="">All Status</option>
                <option value="DRAFT" {% if selected_status == 'DRAFT' %}selected{% endif %}>Draft</option>
                <option value="SUBMITTED" {% if selected_status == 'SUBMITTED' %}selected{% endif %}>Submitted</option>
                <option value="APPROVED" {% if selected_status == 'APPROVED' %}selected{% endif %}>Approved</option>
                <option value="ACTIVE" {% if selected_status == 'ACTIVE' %}selected{% endif %}>Active</option>
                <option value="AMENDED" {% if selected_status == 'AMENDED' %}selected{% endif %}>Amended</option>
                <option value="CLOSED" {% if selected_status == 'CLOSED' %}selected{% endif %}>Closed</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Search</label>
            <input type="text" 
                   name="search" 
                   class="filter-input" 
                   placeholder="Search plan number, title, department..." 
                   value="{{ search_query }}">
        </div>
        
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-filter"></i>
                Apply Filters
            </button>
            {% if selected_budget_year or selected_department or selected_status or search_query %}
            <a href="{% url 'procurement_plan_list' %}" class="btn">
                <i class="bi bi-x-circle"></i>
                Clear
            </a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Plans Table -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Plan Number</th>
                <th>Department</th>
                <th>Budget Year</th>
                <th>Title</th>
                <th>Items</th>
                <th>Estimated Cost</th>
                <th>Status</th>
                <th>Submitted By</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for plan in plans %}
            <tr>
                <td><strong>{{ plan.plan_number }}</strong></td>
                <td>{{ plan.department.code }}</td>
                <td>{{ plan.budget_year.name }}</td>
                <td>
                    {{ plan.title|truncatechars:40 }}
                    {% if plan.is_amended %}
                    <span class="badge badge-warning">
                        <i class="bi bi-pencil"></i> Amended ({{ plan.amendment_count }})
                    </span>
                    {% endif %}
                </td>
                <td>{{ plan.total_items|default:0 }}</td>
                <td class="amount">KES {{ plan.total_estimated_cost|default:0|floatformat:0|intcomma }}</td>
                <td>
                    <span class="status-badge status-{{ plan.status|lower }}">
                        {{ plan.get_status_display }}
                    </span>
                </td>
                <td>{{ plan.submitted_by.get_full_name|default:"-" }}</td>
                <td>{{ plan.created_at|date:"M d, Y" }}</td>
                <td class="actions-cell">
                    <a href="{% url 'procurement_plan_detail' plan.id %}" class="action-link">
                        <i class="bi bi-eye"></i>
                        View
                    </a>
                    {% if plan.status == 'DRAFT' or plan.status == 'SUBMITTED' %}
                    <a href="{% url 'procurement_plan_edit' plan.id %}" class="action-link edit">
                        <i class="bi bi-pencil"></i>
                        Edit
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="10" class="empty-state">
                    <i class="bi bi-file-earmark-x"></i>
                    <p>No procurement plans found.</p>
                    <a href="{% url 'procurement_plan_create' %}" class="btn btn-sm btn-success">
                        <i class="bi bi-plus-circle"></i>
                        Create First Plan
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}